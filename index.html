<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>75 Mastery Hub</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase Compat SDK (Global Objects) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .win-dot { @apply absolute top-1 right-1 w-3 h-3 bg-orange-500 rounded-full border-2 border-slate-900 z-10; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = JSON.parse(__firebase_config);
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : '75-day-mastery-v4';

        // --- COMPONENTS ---

        const Icon = ({ name, className = "w-5 h-5" }) => {
            useEffect(() => {
                if (window.lucide) lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const WeightChart = ({ data }) => {
            if (!data || data.length < 2) {
                return (
                    <div className="h-32 flex items-center justify-center text-slate-600 text-xs italic border border-slate-800 rounded-2xl bg-slate-900/50">
                        Weight trend will appear once you log entries...
                    </div>
                );
            }
            const weights = data.map(d => d.weight);
            const minWeight = Math.min(...weights) - 2;
            const maxWeight = Math.max(...weights) + 2;
            const range = maxWeight - minWeight || 1;
            const width = 300;
            const height = 100;
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * width;
                const y = height - ((d.weight - minWeight) / range) * height;
                return `${x},${y}`;
            }).join(' ');
            return (
                <div className="mt-4 p-4 bg-slate-950 rounded-2xl border border-slate-800">
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-32 overflow-visible">
                        <polyline fill="none" stroke="url(#gradient)" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" points={points} className="drop-shadow-[0_0_8px_rgba(249,115,22,0.4)]" />
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stopColor="#f97316" /><stop offset="100%" stopColor="#ec4899" />
                            </linearGradient>
                        </defs>
                        {data.map((d, i) => (
                            <circle key={i} cx={(i / (data.length - 1)) * width} cy={height - ((d.weight - minWeight) / range) * height} r="3" className="fill-white" />
                        ))}
                    </svg>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('today');
            const [currentDayIndex, setCurrentDayIndex] = useState(0);
            const [daysData, setDaysData] = useState({});
            const [weather, setWeather] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const fileInputRef = useRef(null);
            const [newWeight, setNewWeight] = useState('');

            // App Phase: 'auth', 'setup', 'dashboard'
            const [appPhase, setAppPhase] = useState('auth');
            const [activeProfileId, setActiveProfileId] = useState(null);
            const [usernameInput, setUsernameInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [authStatus, setAuthStatus] = useState({ message: '', type: '' });

            const [profile, setProfile] = useState({
                programType: 'hard_classic',
                startDate: new Date().toISOString().split('T')[0],
                startWeight: '',
                currentWeight: '',
                targetWaterOz: 128,
                workoutCount: 2,
                workoutMins: 45,
                outdoorRequired: true,
                consumptionType: 'reading',
                consumptionGoal: 10,
                dietRequired: true,
                dietDescription: '',
                photoRequired: true,
                photoTitle: 'Progress Photo',
                alcoholRequired: true,
                alcoholLimit: 0,
                intentions: '',
                isConfigured: false,
                measurements: { neck: '', chest: '', waist: '', arms: '', thighs: '', calves: '' }
            });

            // (1) Auth & Persist
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (u) => {
                    if (!u) {
                        try { await auth.signInAnonymously(); } catch(e) {}
                    } else {
                        setUser(u);
                        const linkRef = db.collection('artifacts').doc(appId).collection('users').doc(u.uid).collection('profile').doc('session_link');
                        const linkSnap = await linkRef.get();
                        if (linkSnap.exists && linkSnap.data().activeProfileId) {
                            setActiveProfileId(linkSnap.data().activeProfileId);
                        } else {
                            setAppPhase('auth');
                            setLoading(false);
                        }
                    }
                });
                return () => unsubscribe();
            }, []);

            // (2) Profile Fetching
            useEffect(() => {
                if (!user || !activeProfileId) return;

                const profileRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('profiles').doc(activeProfileId);
                const unsubscribeProfile = profileRef.onSnapshot((docSnap) => {
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        setProfile(prev => ({ ...prev, ...data }));
                        setAppPhase(data.isConfigured ? 'dashboard' : 'setup');

                        if (data.startDate && Object.keys(daysData).length === 0) {
                            const start = new Date(data.startDate);
                            const now = new Date();
                            const diff = Math.floor((now - start) / (1000 * 60 * 60 * 24));
                            setCurrentDayIndex(Math.max(0, Math.min(74, diff)));
                        }
                    }
                    setLoading(false);
                });

                const daysCol = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('days').where('owner', '==', activeProfileId);
                const unsubscribeDays = daysCol.onSnapshot((snapshot) => {
                    const data = {};
                    snapshot.forEach(d => { 
                        const parts = d.id.split('_');
                        const dayKey = parts[parts.length - 1]; // handles day-X
                        data[dayKey] = d.data(); 
                    });
                    setDaysData(data);
                });

                return () => { unsubscribeProfile(); unsubscribeDays(); };
            }, [user, activeProfileId]);

            // Actions
            const handleProfileAuth = async () => {
                const uInput = usernameInput.trim().toLowerCase();
                const pInput = passwordInput.trim();

                if (!uInput || !pInput) {
                    setAuthStatus({ message: "Username and Password required.", type: "error" });
                    return;
                }
                
                const profileRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('profiles').doc(uInput);
                
                try {
                    const docSnap = await profileRef.get();
                    if (docSnap.exists) {
                        if (docSnap.data().passcode === pInput) {
                            await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('profile').doc('session_link').set({ activeProfileId: uInput });
                            setActiveProfileId(uInput);
                        } else {
                            setAuthStatus({ message: "Username taken. Incorrect password.", type: "error" });
                        }
                    } else {
                        const newProfile = { ...profile, passcode: pInput, isConfigured: false, startDate: new Date().toISOString().split('T')[0] };
                        await profileRef.set(newProfile);
                        await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('profile').doc('session_link').set({ activeProfileId: uInput });
                        setActiveProfileId(uInput);
                    }
                } catch (err) { setAuthStatus({ message: "Error connecting to cloud.", type: "error" }); }
            };

            const finalizeSetup = async () => {
                if (!profile.dietDescription.trim()) {
                    setAuthStatus({ message: "Define your diet protocol.", type: "error" });
                    return;
                }
                await updateProfile({ isConfigured: true });
            };

            const handleSignOut = async () => {
                if (confirm("Sign out? This device will forget this profile.")) {
                    await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('profile').doc('session_link').set({ activeProfileId: null });
                    setActiveProfileId(null);
                    setAppPhase('auth');
                    window.location.reload();
                }
            };

            const updateProfile = async (updates) => {
                if (!activeProfileId) return;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('profiles').doc(activeProfileId).set(updates, { merge: true });
            };

            const updateDayData = async (dayIdx, updates) => {
                const dayId = `${activeProfileId}_day-${dayIdx + 1}`;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('days').doc(dayId).set({
                    ...updates, owner: activeProfileId, day: dayIdx + 1
                }, { merge: true });
            };

            const applyProgramPreset = async (type) => {
                let updates = { programType: type };
                if (type === 'hard_classic') {
                    updates = { ...updates, workoutCount: 2, workoutMins: 45, outdoorRequired: true, targetWaterOz: 128, consumptionType: 'reading', consumptionGoal: 10, dietRequired: true, photoRequired: true, photoTitle: 'Progress Photo', alcoholRequired: true, alcoholLimit: 0 };
                } else if (type === 'medium') {
                    updates = { ...updates, workoutCount: 1, workoutMins: 45, outdoorRequired: false, targetWaterOz: 128, consumptionType: 'reading', consumptionGoal: 10, dietRequired: true, photoRequired: true, photoTitle: 'Progress Photo', alcoholRequired: true, alcoholLimit: 0 };
                } else if (type === 'soft') {
                    updates = { ...updates, workoutCount: 1, workoutMins: 30, outdoorRequired: false, targetWaterOz: 64, consumptionType: 'reading', consumptionGoal: 5, dietRequired: true, photoRequired: false, alcoholRequired: false, alcoholLimit: 7 };
                }
                await updateProfile(updates);
            };

            const handlePhotoUpload = async (e) => {
                const file = e.target.files?.[0];
                if (!file || !user || !activeProfileId) return;
                setIsUploading(true);
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const base64String = reader.result;
                    const dayKey = `day-${currentDayIndex + 1}`;
                    const existingTasks = daysData[dayKey]?.tasks || {};
                    await updateDayData(currentDayIndex, { photoData: base64String, tasks: { ...existingTasks, photo: true } });
                    setIsUploading(false);
                };
                reader.readAsDataURL(file);
            };

            const removePhoto = async () => {
                if (!confirm("Remove this photo?")) return;
                const dayKey = `day-${currentDayIndex + 1}`;
                const existingTasks = daysData[dayKey]?.tasks || {};
                await updateDayData(currentDayIndex, { photoData: null, tasks: { ...existingTasks, photo: false } });
            };

            const checkDayComplete = (dayInfo) => {
                if (!dayInfo) return false;
                const t = dayInfo.tasks || {};
                const waterMet = (dayInfo.waterOz || 0) >= (profile.targetWaterOz || 128);
                const w1 = t.workout1 === true;
                const w2 = profile.workoutCount === 2 ? t.workout2 === true : true;
                const diet = t.diet === true;
                const reading = t.consumption === true;
                const photo = profile.photoRequired ? t.photo === true : true;
                const alcohol = profile.alcoholRequired ? t.alcohol === true : true;
                return waterMet && w1 && w2 && diet && reading && photo && alcohol;
            };

            const totals = useMemo(() => {
                let totalMins = 0; let completedCount = 0;
                Object.values(daysData).forEach(day => {
                    const mins = (parseInt(day.workout1_mins || 0) + (parseInt(day.workout1_hrs || 0) * 60)) + (parseInt(day.workout2_mins || 0) + (parseInt(day.workout2_hrs || 0) * 60));
                    totalMins += mins;
                    if (checkDayComplete(day)) completedCount++;
                });
                const weightLost = (profile.startWeight && profile.currentWeight) ? (parseFloat(profile.startWeight) - parseFloat(profile.currentWeight)).toFixed(1) : '0.0';
                return { hours: Math.floor(totalMins / 60), mins: totalMins % 60, completedDays: completedCount, weightLost };
            }, [daysData, profile]);

            const progressPercent = Math.round((totals.completedDays / 75) * 100);

            if (loading) return <div className="flex flex-col items-center justify-center h-screen bg-slate-950 text-orange-500 uppercase tracking-widest font-black gap-4"><div className="w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin"></div>Syncing Hub...</div>;

            if (appPhase === 'auth') {
                return (
                    <div className="min-h-screen bg-slate-950 flex items-center justify-center p-6 font-sans">
                        <div className="max-w-md w-full space-y-8">
                            <div className="text-center space-y-2">
                                <div className="inline-block p-4 bg-orange-500 rounded-3xl text-white shadow-2xl mb-4 animate-bounce"><Icon name="trophy" className="w-10 h-10" /></div>
                                <h1 className="text-4xl font-black uppercase text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-rose-600 tracking-tighter leading-none">75 Mastery</h1>
                                <p className="text-xs text-slate-500 font-bold uppercase tracking-widest mt-2">Persistence Infrastructure</p>
                            </div>
                            <div className="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-2xl space-y-6">
                                <div className="space-y-4">
                                    <div className="relative"><Icon name="user" className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-600" /><input type="text" className="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 pl-12 text-white outline-none focus:border-indigo-500 font-bold" placeholder="Username" value={usernameInput} onChange={(e) => setUsernameInput(e.target.value)} /></div>
                                    <div className="relative"><Icon name="key-round" className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-600" /><input type="password" className="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 pl-12 text-white outline-none focus:border-indigo-500 font-bold" placeholder="Password" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} /></div>
                                </div>
                                {authStatus.message && <div className={`p-3 rounded-xl text-[10px] font-black uppercase text-center ${authStatus.type === 'error' ? 'bg-rose-500/10 text-rose-500' : 'bg-green-500/10 text-green-500'}`}>{authStatus.message}</div>}
                                <button onClick={handleProfileAuth} className="w-full bg-indigo-500 p-5 rounded-2xl text-white font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all text-sm">Login or Create Account</button>
                                <div className="pt-4 border-t border-slate-800 flex gap-2 text-slate-500">
                                    <Icon name="alert-circle" className="w-8 h-8 text-amber-500 shrink-0" />
                                    <p className="text-[10px] leading-relaxed font-medium uppercase italic"><span className="text-amber-400 font-black">Shared Device Disclaimer:</span> If you are on a public computer, sign out before closing to protect your privacy.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            const currentDayKey = `day-${currentDayIndex + 1}`;
            const currentDayData = daysData[currentDayKey] || { tasks: {}, waterOz: 0, workout1_desc: '', workout2_desc: '', workout1_hrs: '', workout1_mins: '', workout2_hrs: '', workout2_mins: '', consumptionTitle: '', photoData: null, weight: '' };
            const waterDone = (currentDayData.waterOz || 0) >= (profile.targetWaterOz || 128);

            const w1MinsTotal = (parseInt(currentDayData.workout1_hrs) || 0) * 60 + (parseInt(currentDayData.workout1_mins) || 0);
            const w2MinsTotal = (parseInt(currentDayData.workout2_hrs) || 0) * 60 + (parseInt(currentDayData.workout2_mins) || 0);

            const pillars = [
                { id: 'workout1', label: profile.outdoorRequired ? 'Outdoor Workout' : 'Workout One', icon: "dumbbell", sub: `${profile.workoutMins} Min Req`, qualifies: w1MinsTotal >= profile.workoutMins },
                ...(profile.workoutCount === 2 ? [{ id: 'workout2', label: 'Workout Two', icon: "dumbbell", sub: `${profile.workoutMins} Min Req`, qualifies: w2MinsTotal >= profile.workoutMins }] : []),
                { id: 'consumption', label: profile.programType === 'hard_classic' ? 'Book Reading' : (profile.consumptionType === 'reading' ? 'Book Reading' : 'Listen to Podcast'), icon: profile.consumptionType === 'reading' ? "book-open" : "mic", sub: `Goal: ${profile.consumptionGoal} ${profile.consumptionType === 'reading' ? 'Pages' : 'Mins'}` },
                ...(profile.photoRequired ? [{ id: 'photo', label: profile.photoTitle || 'Visual Progress', icon: "camera", sub: 'Daily Selfie' }] : []),
                { id: 'diet', label: 'Follow a Diet', icon: "utensils", sub: profile.programType === 'hard_classic' ? `${profile.dietDescription || 'Standard'} â€¢ No Cheats` : (profile.dietDescription || 'No Cheats') },
                ...(profile.alcoholRequired ? [{ id: 'alcohol', label: profile.alcoholLimit === 0 ? 'No Alcohol' : 'Alcohol within Limit', icon: "beer", sub: profile.alcoholLimit === 0 ? 'Zero Tolerance' : `Max ${profile.alcoholLimit} drinks / week` }] : [])
            ];

            return (
                <div className="min-h-screen bg-slate-950 text-slate-100 font-sans pb-32">
                    <header className="p-6 bg-slate-900 border-b border-slate-800 sticky top-0 z-40">
                        <div className="flex justify-between items-start mb-6">
                            <div><h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-rose-600 tracking-tighter uppercase leading-none">75 Mastery</h1><p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-2 flex items-center gap-1"><Icon name="shield-check" className="w-3 h-3 text-green-500" /> Profil: {activeProfileId}</p></div>
                            <div className="text-right flex flex-col items-end"><div className="text-xs font-black text-orange-400 flex items-center gap-1 uppercase tracking-widest"><Icon name="sun" className="w-3 h-3" /> Day {currentDayIndex+1}</div></div>
                        </div>
                        <div className="relative h-3 bg-slate-800 rounded-full overflow-hidden mb-2 shadow-inner"><div className="absolute h-full bg-gradient-to-r from-orange-500 to-rose-500 transition-all duration-1000" style={{ width: `${progressPercent}%` }} /></div>
                        <div className="flex justify-between text-[10px] font-black text-slate-500 uppercase tracking-tighter"><span>{progressPercent}% Mastery</span><span>{totals.completedDays} Wins</span></div>
                    </header>

                    {appPhase === 'dashboard' && (
                        <nav className="flex px-4 py-2 gap-2 bg-slate-950 sticky top-[138px] z-30 shadow-2xl border-b border-slate-900 overflow-x-auto scrollbar-hide">
                            <button onClick={() => setActiveTab('today')} className={`flex-1 min-w-[90px] py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex flex-col items-center gap-1 ${activeTab === 'today' ? 'bg-orange-500 text-white shadow-lg shadow-orange-500/30' : 'text-slate-400'}`}><Icon name="calendar" /> Today</button>
                            <button onClick={() => setActiveTab('gallery')} className={`flex-1 min-w-[90px] py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex flex-col items-center gap-1 ${activeTab === 'gallery' ? 'bg-orange-500 text-white shadow-lg shadow-orange-500/30' : 'text-slate-400'}`}><Icon name="layout-grid" /> Gallery</button>
                            <button onClick={() => setActiveTab('stats')} className={`flex-1 min-w-[90px] py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex flex-col items-center gap-1 ${activeTab === 'stats' ? 'bg-orange-500 text-white shadow-lg shadow-orange-500/30' : 'text-slate-400'}`}><Icon name="activity" /> Stats</button>
                            <button onClick={() => setActiveTab('setup')} className={`flex-1 min-w-[90px] py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex flex-col items-center gap-1 ${activeTab === 'setup' ? 'bg-orange-500 text-white shadow-lg shadow-orange-500/30' : 'text-slate-400'}`}><Icon name="settings" /> Setup</button>
                        </nav>
                    )}

                    <main className="p-4 max-w-lg mx-auto space-y-6">
                        {appPhase === 'setup' && (
                            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-700">
                                <div className="p-6 bg-indigo-500/10 border border-indigo-500/30 rounded-[2.5rem] text-center space-y-4"><Icon name="target" className="w-12 h-12 text-indigo-400 mx-auto" /><h2 className="text-2xl font-black uppercase tracking-tight leading-none">Initial Configuration</h2><p className="text-xs text-indigo-300 font-bold uppercase tracking-widest leading-relaxed">Finalize your mastery rules to unlock your dashboard.</p></div>
                                <div className="bg-slate-900 p-6 rounded-[2.5rem] border border-slate-800 shadow-xl space-y-6">
                                    <div className="p-4 bg-slate-800/20 rounded-2xl border border-slate-800"><label className="block text-[10px] font-black text-slate-500 uppercase mb-2 tracking-widest">Preset Mode</label><select className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none font-bold" value={profile.programType} onChange={(e) => applyProgramPreset(e.target.value)}><option value="hard_classic">75 Hard (Classic Rules)</option><option value="medium">75 Medium</option><option value="soft">75 Soft</option><option value="custom">Fully Custom</option></select></div>
                                    <div><label className="block text-[10px] font-black text-slate-500 uppercase mb-2 tracking-widest">Diet Description</label><input type="text" className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none" placeholder="e.g. Keto, IF" value={profile.dietDescription} onChange={(e) => updateProfile({ dietDescription: e.target.value })} /></div>
                                    <div><label className="block text-[10px] font-black text-slate-500 uppercase mb-2 tracking-widest">Big "Why" / Intentions</label><textarea className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none h-24 italic" placeholder="My reason for mastery..." value={profile.intentions} onChange={(e) => updateProfile({ intentions: e.target.value })} /></div>
                                    <button onClick={finalizeSetup} className="w-full bg-orange-500 p-5 rounded-2xl text-white font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all text-sm">Commit to Challenge</button>
                                </div>
                            </div>
                        )}

                        {appPhase === 'dashboard' && activeTab === 'today' && (
                            <>
                                {profile.intentions && <div className="p-4 bg-orange-500/5 border border-orange-500/20 rounded-2xl text-center italic text-sm text-orange-200/70 shadow-lg italic">"{profile.intentions}"</div>}
                                <div className="flex items-center justify-between bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-xl"><button onClick={() => setCurrentDayIndex(Math.max(0, currentDayIndex - 1))} className="p-2 text-slate-500 hover:text-orange-500 transition-colors"><Icon name="chevron-left" /></button><div className="text-center"><h2 className="text-xl font-black uppercase tracking-tighter">DAY {currentDayIndex + 1}</h2><p className="text-[10px] text-orange-500 font-bold uppercase tracking-widest">{new Date(new Date(profile.startDate).getTime() + currentDayIndex * 86400000).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</p></div><button onClick={() => setCurrentDayIndex(Math.min(74, currentDayIndex + 1))} className="p-2 text-slate-500 hover:text-orange-500 transition-colors"><Icon name="chevron-right" /></button></div>

                                <div className={`p-5 rounded-3xl border transition-all duration-500 shadow-xl ${waterDone ? 'bg-cyan-500/10 border-cyan-500/50 shadow-cyan-500/5' : 'bg-slate-900 border-slate-800'}`}>
                                    <div className="flex justify-between items-center mb-4"><div className="flex items-center gap-2"><div className={`p-2 rounded-lg ${waterDone ? 'bg-cyan-500 text-white' : 'bg-cyan-500/20 text-cyan-400'}`}><Icon name="droplets" /></div><h3 className="font-black text-sm uppercase tracking-wider">Hydration</h3></div><div className="text-right flex items-center gap-2 font-black"><input type="number" className="bg-slate-950 border border-slate-800 px-2 py-1 rounded w-16 text-center text-white outline-none" value={currentDayData.waterOz || 0} onChange={(e) => updateDayData(currentDayIndex, { waterOz: parseInt(e.target.value) || 0 })} /><span className="text-xs text-slate-500">/ {profile.targetWaterOz} OZ</span></div></div>
                                    <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">{[8, 16, 24, 32].map(oz => (<button key={oz} onClick={() => updateDayData(currentDayIndex, { waterOz: (currentDayData.waterOz || 0) + oz })} className="bg-slate-800 border border-slate-700 px-4 py-2 rounded-xl text-xs font-bold text-slate-300 active:bg-cyan-500 transition-all active:scale-95">+{oz}oz</button>))}</div>
                                </div>

                                <div className="space-y-4">
                                    {pillars.map(p => {
                                        const done = currentDayData.tasks?.[p.id];
                                        if (p.id.startsWith('workout')) {
                                            const color = p.id === 'workout1' ? 'orange' : 'blue';
                                            return (
                                                <div key={p.id} className={`p-5 rounded-3xl border transition-all duration-300 ${done ? `bg-${color}-500/10 border-${color}-500/50 shadow-inner shadow-black/20` : 'bg-slate-900 border-slate-800 shadow-xl'}`}>
                                                    <div className="flex justify-between items-start mb-4"><div className="flex items-center gap-2"><div className={`p-2 rounded-lg ${done ? `bg-${color}-500 text-white` : 'bg-slate-800 text-slate-500'}`}><Icon name={p.icon} /></div><div><h3 className={`font-black text-sm uppercase tracking-wider ${done ? 'text-slate-100' : 'text-slate-300'}`}>{p.label}</h3><p className="text-[10px] text-slate-500 font-bold uppercase">{p.sub}</p></div></div><div className="flex gap-1"><input type="number" className="w-10 bg-slate-950 border border-slate-800 rounded px-1 text-center font-bold text-white outline-none" placeholder="H" value={currentDayData[`${p.id}_hrs`] || ''} onChange={(e) => updateDayData(currentDayIndex, { [`${p.id}_hrs`]: e.target.value })} /><span className="text-slate-600 font-bold">:</span><input type="number" className="w-10 bg-slate-950 border border-slate-800 rounded px-1 text-center font-bold text-white outline-none" placeholder="M" value={currentDayData[`${p.id}_mins`] || ''} onChange={(e) => updateDayData(currentDayIndex, { [`${p.id}_mins`]: e.target.value })} /></div></div>
                                                    <textarea className="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-sm text-slate-300 outline-none h-20 mb-3" placeholder="Notes..." value={currentDayData[`${p.id}_desc`] || ''} onChange={(e) => updateDayData(currentDayIndex, { [`${p.id}_desc`]: e.target.value })} />
                                                    <div className="flex items-center gap-3">
                                                        <div className="flex-1">{done ? (<div className="w-full py-3 rounded-xl font-black text-xs uppercase border border-slate-700 bg-slate-800 text-slate-400 flex items-center justify-center gap-2"><Icon name="check-circle-2" className="text-green-500" /> Workout Logged</div>) : (<button disabled={!p.qualifies} onClick={() => updateDayData(currentDayIndex, { tasks: { ...currentDayData.tasks, [p.id]: true }})} className={`w-full py-3 rounded-xl font-black text-xs uppercase border transition-all ${p.qualifies ? `bg-${color}-500 border-${color}-400 text-white shadow-lg` : 'bg-slate-950 border-slate-800 text-slate-700 cursor-not-allowed'}`}>{p.qualifies ? 'Log Workout' : 'Min Not Met'}</button>)}</div>
                                                        {done && <button onClick={() => updateDayData(currentDayIndex, { tasks: { ...currentDayData.tasks, [p.id]: false }})} className="p-3 bg-slate-800 border border-slate-700 rounded-xl text-slate-500 hover:text-rose-500"><Icon name="undo-2" /></button>}
                                                    </div>
                                                </div>
                                            );
                                        }
                                        if (p.id === 'consumption') return <div key={p.id} className={`p-5 rounded-3xl border transition-all duration-300 ${done ? 'bg-purple-500/10 border-purple-500/50 shadow-inner' : 'bg-slate-900 border-slate-800 shadow-xl'}`}><div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><div className={`p-2 rounded-lg ${done ? 'bg-purple-500 text-white shadow-lg' : 'bg-purple-500/20 text-purple-400'}`}><Icon name={p.icon} /></div><h3 className="font-black text-sm uppercase tracking-wider">{p.label}</h3></div><button onClick={() => updateDayData(currentDayIndex, { tasks: { ...currentDayData.tasks, consumption: !done }})} className={`px-4 py-2 rounded-xl font-black text-[10px] uppercase border transition-all ${done ? 'bg-purple-500 border-purple-400 text-white' : 'bg-slate-800 border-slate-700 text-slate-500'}`}>{done ? 'Done' : 'Mark Done'}</button></div><input type="text" className="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-sm text-slate-300 outline-none focus:border-purple-500" placeholder="Title..." value={currentDayData.consumptionTitle || ''} onChange={(e) => updateDayData(currentDayIndex, { consumptionTitle: e.target.value })} /><p className="text-[10px] text-slate-600 font-bold mt-2 uppercase text-center tracking-widest">{p.sub}</p></div>;
                                        if (p.id === 'photo') return <div key={p.id} className={`p-5 rounded-3xl border transition-all duration-300 ${done ? 'bg-pink-500/10 border-pink-500/50 shadow-inner' : 'bg-slate-900 border-slate-800 shadow-xl'}`}><div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><div className={`p-2 rounded-lg ${done ? 'bg-pink-500 text-white' : 'bg-pink-500/20 text-pink-500'}`}><Icon name="camera" /></div><h3 className="font-black text-sm uppercase tracking-wider">{p.label}</h3></div>{currentDayData.photoData && <button onClick={removePhoto} className="p-2 bg-red-500/10 text-red-500 rounded-lg hover:bg-red-500/20 transition-all"><Icon name="x" /></button>}</div><div onClick={() => fileInputRef.current?.click()} className={`relative aspect-video rounded-2xl border-2 border-dashed transition-all flex flex-col items-center justify-center overflow-hidden cursor-pointer ${currentDayData.photoData ? 'border-pink-500/50' : 'border-slate-800 bg-slate-800/20 hover:border-pink-500/30'}`}>{currentDayData.photoData ? <img src={currentDayData.photoData} alt="Progress" className="w-full h-full object-cover" /> : <div className="flex flex-col items-center text-slate-500">{isUploading ? <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500" /> : <><Icon name="upload" className="w-8 h-8 mb-2" /><span className="text-xs font-black uppercase tracking-widest">Capture Win</span></>}</div>}<input type="file" ref={fileInputRef} onChange={handlePhotoUpload} accept="image/*" className="hidden" /></div></div>;
                                        if (p.id === 'diet' || p.id === 'alcohol') {
                                            const color = p.id === 'diet' ? 'green' : 'amber';
                                            return <button key={p.id} onClick={() => updateDayData(currentDayIndex, { tasks: { ...currentDayData.tasks, [p.id]: !done }})} className={`w-full flex items-center p-5 rounded-3xl border transition-all ${done ? `bg-${color}-500/10 border-${color}-500/50 shadow-inner` : 'bg-slate-900 border-slate-800 shadow-xl'}`}><div className={`p-2 rounded-lg mr-4 ${done ? `bg-${color}-500 text-white shadow-md` : `bg-${color}-500/20 text-${color}-500`}`}><Icon name={p.icon} /></div><div className="flex-1 text-left"><span className="block font-black text-sm uppercase tracking-wider">{p.label}</span><span className="text-[10px] text-slate-500 font-bold uppercase">{p.sub}</span></div>{done ? <Icon name="check-circle-2" className={`text-${color}-500 w-5 h-5`} /> : <Icon name="circle" className="text-slate-700 w-5 h-5" />}</button>;
                                        }
                                        return null;
                                    })}
                                </div>
                            </>
                        )}

                        {appPhase === 'dashboard' && activeTab === 'gallery' && (
                            <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-2xl">
                                <div className="flex items-center justify-between mb-6"><h3 className="text-lg font-black flex items-center gap-2"><Icon name="image" className="text-pink-500" /> Evolution Gallery</h3><span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">{totals.completedDays} Wins</span></div>
                                <div className="grid grid-cols-3 sm:grid-cols-4 gap-3">
                                    {Array.from({ length: 75 }).map((_, i) => {
                                        const dKey = `day-${i + 1}`;
                                        const info = daysData[dKey];
                                        const isComp = checkDayComplete(info);
                                        return <button key={i} onClick={() => { setCurrentDayIndex(i); setActiveTab('today'); }} className={`aspect-square relative rounded-xl border transition-all overflow-hidden flex flex-col items-center justify-center ${i === currentDayIndex ? 'border-orange-500 ring-2 ring-orange-500/20' : 'border-slate-800 bg-slate-800/30'}`}>{info?.photoData ? <img src={info.photoData} className="w-full h-full object-cover" /> : <div className="text-[8px] font-black text-slate-700 uppercase">Day {i+1}</div>}{isComp && <div className="absolute top-1 right-1 w-3 h-3 bg-orange-500 rounded-full border-2 border-slate-900 z-10" />}</button>;
                                    })}
                                </div>
                            </div>
                        )}

                        {appPhase === 'dashboard' && activeTab === 'stats' && (
                            <div className="space-y-6">
                                <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl overflow-hidden relative">
                                    <div className="absolute top-0 right-0 w-48 h-48 bg-orange-500/5 blur-3xl -mr-24 -mt-24" />
                                    <h3 className="text-lg font-black mb-2 flex items-center gap-2 uppercase tracking-tight"><Icon name="activity" className="w-5 h-5 text-orange-500" /> Progress Trend</h3>
                                    <WeightChart data={weightTrendData} />
                                    <div className="grid grid-cols-2 gap-4 mt-6">
                                        <div className="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50 text-center"><p className="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Total Loss</p><p className="text-2xl font-black text-green-400">-{totals.weightLost} LBS</p></div>
                                        <div className="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50 text-center"><p className="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Total Effort</p><p className="text-2xl font-black text-cyan-400">{totals.hours}h {totals.mins}m</p></div>
                                    </div>
                                </div>

                                <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl">
                                    <h3 className="text-lg font-black mb-6 flex items-center gap-2"><Icon name="ruler" className="w-5 h-5 text-orange-500" /> Body Snapshot</h3>
                                    <div className="grid grid-cols-2 gap-3 mb-6">
                                        <div className="relative"><label className="text-[9px] font-black text-slate-600 uppercase absolute top-2 left-3">Start</label><input type="number" step="0.1" className="w-full bg-slate-950 border border-slate-800 pt-6 pb-2 px-3 rounded-xl text-white font-bold outline-none" value={profile.startWeight} onChange={(e) => updateProfile({ startWeight: e.target.value })} /></div>
                                        <div className="relative"><label className="text-[9px] font-black text-slate-600 uppercase absolute top-2 left-3">Latest</label><input type="number" disabled className="w-full bg-slate-900/50 border border-slate-800 pt-6 pb-2 px-3 rounded-xl text-slate-500 font-bold" value={profile.currentWeight} /></div>
                                    </div>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                        {Object.keys(profile.measurements).map(key => (
                                            <div key={key} className="relative"><label className="text-[9px] font-black text-slate-600 uppercase absolute top-2 left-3 tracking-tighter">{key}</label><input type="number" step="0.1" className="w-full bg-slate-950 border border-slate-800 pt-6 pb-2 px-3 rounded-xl text-white font-bold outline-none" value={profile.measurements[key]} onChange={(e) => updateProfile({ measurements: { ...profile.measurements, [key]: e.target.value }})} /></div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl border-t-orange-500/20">
                                    <h3 className="text-lg font-black mb-4 flex items-center gap-2"><Icon name="scale" className="w-5 h-5 text-orange-500" /> Manual Weight Log</h3>
                                    <div className="flex gap-2">
                                        <input type="number" step="0.1" className="flex-1 bg-slate-950 border border-slate-800 p-3 rounded-xl text-white font-bold outline-none" placeholder="Enter weight..." value={newWeight} onChange={(e) => setNewWeight(e.target.value)} />
                                        <button onClick={() => { const idx = Math.max(0, Math.floor((new Date() - new Date(profile.startDate)) / 86400000)); updateDayData(idx, { weight: newWeight }); setNewWeight(''); }} className="bg-orange-500 text-white font-black px-6 rounded-xl text-xs uppercase tracking-widest shadow-lg">Log</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {appPhase === 'dashboard' && activeTab === 'setup' && (
                            <div className="space-y-6">
                                <div className="bg-gradient-to-br from-indigo-950 to-slate-900 p-6 rounded-3xl border border-indigo-500/30 shadow-xl relative overflow-hidden">
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-500/10 blur-3xl -mr-16 -mt-16" />
                                    <div className="flex items-center gap-3 mb-6">
                                        <div className="p-3 bg-indigo-500 rounded-2xl text-white shadow-lg"><Icon name="user" className="w-6 h-6" /></div>
                                        <div><h3 className="text-lg font-black tracking-tight uppercase leading-none">Identity Manager</h3><p className="text-[9px] text-indigo-400 font-bold uppercase tracking-widest mt-1">Cross-Device Session</p></div>
                                    </div>
                                    <div className="bg-slate-950/50 rounded-2xl p-4 border border-slate-800 mb-4">
                                        <p className="text-[9px] font-black text-slate-500 uppercase mb-2">Username</p>
                                        <p className="text-sm font-mono text-indigo-300 break-all uppercase tracking-widest font-bold">{activeProfileId}</p>
                                    </div>
                                    <button onClick={handleSignOut} className="w-full bg-slate-800 border border-slate-700 p-4 rounded-2xl text-rose-500 font-black uppercase tracking-widest text-[10px] flex items-center justify-center gap-2 hover:bg-rose-500/10 transition-all">
                                        <Icon name="log-out" className="w-4 h-4" /> Sign Out / Switch User
                                    </button>
                                </div>

                                <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl">
                                    <h3 className="text-lg font-black mb-4 flex items-center gap-2 text-orange-400"><Icon name="target" className="w-5 h-5" /> Mastery Settings</h3>
                                    <div className="space-y-6">
                                        <div className="p-4 bg-slate-800/20 rounded-2xl border border-slate-800">
                                            <label className="block text-[10px] font-black text-slate-500 uppercase mb-2">Program Preset</label>
                                            <select className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none font-bold" value={profile.programType} onChange={(e) => applyProgramPreset(e.target.value)}>
                                                <option value="hard_classic">75 Hard (Classic Rules)</option>
                                                <option value="medium">75 Medium</option>
                                                <option value="soft">75 Soft</option>
                                                <option value="custom">Fully Custom</option>
                                            </select>
                                        </div>
                                        <div><label className="block text-[10px] font-black text-slate-500 uppercase mb-2">Program Start Date</label><input type="date" className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none" value={profile.startDate} onChange={(e) => updateProfile({ startDate: e.target.value })} /></div>
                                        <div className="p-4 bg-slate-800/20 rounded-2xl border border-slate-800 space-y-4">
                                            <h4 className="text-[10px] font-black text-slate-500 uppercase border-b border-slate-800 pb-2 flex items-center gap-2 tracking-widest"><Icon name="dumbbell" className="w-3 h-3" /> Workouts</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="block text-[10px] text-slate-500 uppercase mb-2">Daily Count</label><select disabled={profile.programType === 'hard_classic'} className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none disabled:opacity-50" value={profile.workoutCount} onChange={(e) => updateProfile({ workoutCount: parseInt(e.target.value) })}><option value={1}>1</option><option value={2}>2</option></select></div>
                                                <div><label className="block text-[10px] text-slate-500 uppercase mb-2">Min Minutes</label><input disabled={profile.programType === 'hard_classic'} type="number" className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none disabled:opacity-50 font-bold" value={profile.workoutMins} onChange={(e) => updateProfile({ workoutMins: parseInt(e.target.value) })} /></div>
                                            </div>
                                        </div>
                                        <div className="p-4 bg-slate-800/20 rounded-2xl border border-slate-800 space-y-4">
                                            <h4 className="text-[10px] font-black text-slate-500 uppercase border-b border-slate-800 pb-2 flex items-center gap-2 tracking-widest"><Icon name="utensils" className="w-3 h-3" /> Nutrition</h4>
                                            <div><label className="block text-[10px] text-slate-500 uppercase mb-2">Diet Goal</label><input type="text" className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none" placeholder="e.g. Keto" value={profile.dietDescription} onChange={(e) => updateProfile({ dietDescription: e.target.value })} /></div>
                                        </div>
                                        <div><label className="block text-[10px] font-black text-slate-500 uppercase mb-2">Your Big "Why"</label><textarea className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none focus:border-orange-500 h-24 italic" value={profile.intentions} onChange={(e) => updateProfile({ intentions: e.target.value })} /></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {appPhase === 'dashboard' && (
                        <footer className="fixed bottom-0 left-0 right-0 bg-slate-900/90 backdrop-blur-xl border-t border-slate-800 px-6 py-4 flex justify-around items-center z-50 shadow-[0_-10px_20px_rgba(0,0,0,0.5)]">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-slate-800 rounded-full shadow-lg border border-slate-700"><Icon name="trophy" className={totals.completedDays > 0 ? "text-orange-500 animate-pulse" : "text-slate-500"} /></div>
                                <div><p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Consistency</p><p className="text-lg font-black text-white">{totals.completedDays} Wins</p></div>
                            </div>
                            <div className="text-right">
                                <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Total Volume</p>
                                <p className="text-lg font-black text-cyan-400">{totals.hours}h <span className="text-[10px] uppercase text-slate-500 font-bold">Done</span></p>
                            </div>
                        </footer>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>