import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query } from 'firebase/firestore';
import { 
  CheckCircle2, 
  Circle, 
  Droplets, 
  Dumbbell, 
  BookOpen, 
  Camera, 
  Utensils, 
  TrendingUp, 
  Calendar, 
  ChevronRight, 
  ChevronLeft,
  RotateCcw,
  Clock,
  Sun,
  Thermometer,
  Settings,
  History,
  MessageSquare,
  LayoutGrid,
  Image as ImageIcon,
  Library,
  Upload,
  X,
  Scale,
  Ruler,
  Trophy,
  Activity,
  Mic,
  Target,
  CloudSun,
  Beer,
  Lock,
  Type,
  AlertCircle,
  Undo2,
  User as UserIcon,
  LogOut,
  ShieldCheck,
  Fingerprint,
  LogIn,
  KeyRound,
  UserPlus,
  ArrowRight
} from 'lucide-react';

// --- FIREBASE INITIALIZATION ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : '75-day-mastery-v3';

// --- HELPER COMPONENTS ---
const WeightChart = ({ data }) => {
  if (!data || data.length < 2) {
    return (
      <div className="h-32 flex items-center justify-center text-slate-600 text-xs italic border border-slate-800 rounded-2xl bg-slate-900/50">
        Chart will appear once you log weight on multiple days...
      </div>
    );
  }
  const weights = data.map(d => d.weight);
  const minWeight = Math.min(...weights) - 2;
  const maxWeight = Math.max(...weights) + 2;
  const range = maxWeight - minWeight || 1;
  const width = 300;
  const height = 100;
  const points = data.map((d, i) => {
    const x = (i / (data.length - 1)) * width;
    const y = height - ((d.weight - minWeight) / range) * height;
    return `${x},${y}`;
  }).join(' ');
  return (
    <div className="mt-4 p-4 bg-slate-950 rounded-2xl border border-slate-800">
      <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-32 overflow-visible">
        <polyline fill="none" stroke="url(#gradient)" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" points={points} className="drop-shadow-[0_0_8px_rgba(249,115,22,0.4)]" />
        <defs>
          <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stopColor="#f97316" /><stop offset="100%" stopColor="#ec4899" />
          </linearGradient>
        </defs>
        {data.map((d, i) => (
          <circle key={i} cx={(i / (data.length - 1)) * width} cy={height - ((d.weight - minWeight) / range) * height} r="3" className="fill-white" />
        ))}
      </svg>
    </div>
  );
};

export default function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('today'); 
  const [currentDayIndex, setCurrentDayIndex] = useState(0); 
  const [daysData, setDaysData] = useState({});
  const [weather, setWeather] = useState(null);
  const [isUploading, setIsUploading] = useState(false);
  const fileInputRef = useRef(null);
  const [newWeight, setNewWeight] = useState('');
  
  // Profile Logic
  const [appPhase, setAppPhase] = useState('auth');
  const [activeProfileId, setActiveProfileId] = useState(null);
  const [usernameInput, setUsernameInput] = useState('');
  const [passwordInput, setPasswordInput] = useState('');
  const [authStatus, setAuthStatus] = useState({ message: '', type: '' });

  const [profile, setProfile] = useState({
    programType: 'hard_classic', 
    startDate: new Date().toISOString().split('T')[0],
    startWeight: '',
    currentWeight: '',
    targetWaterOz: 128,
    workoutCount: 2,
    workoutMins: 45,
    outdoorRequired: true,
    consumptionType: 'reading',
    consumptionGoal: 10,
    dietRequired: true,
    dietDescription: '',
    photoRequired: true,
    photoTitle: 'Progress Photo',
    alcoholRequired: true,
    alcoholLimit: 0, 
    intentions: '',
    passcode: '', // Logic mapped to 'Password'
    isConfigured: false,
    measurements: { neck: '', chest: '', waist: '', arms: '', thighs: '', calves: '' }
  });

  // (1) Auth & Persistence Session Link
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error("Auth error:", err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, async (u) => {
      setUser(u);
      if (u) {
        const linkRef = doc(db, 'artifacts', appId, 'users', u.uid, 'profile', 'session_link');
        const linkSnap = await getDoc(linkRef);
        if (linkSnap.exists()) {
          const linkedId = linkSnap.data().activeProfileId;
          if (linkedId) {
             setActiveProfileId(linkedId);
          } else {
             setAppPhase('auth');
             setLoading(false);
          }
        } else {
          setAppPhase('auth');
          setLoading(false);
        }
      }
    });
    return () => unsubscribe();
  }, []);

  // (2) Profile Data Fetching & Phase Selection
  useEffect(() => {
    if (!user || !activeProfileId) return;

    const profileRef = doc(db, 'artifacts', appId, 'users', activeProfileId, 'profile', 'data');
    const unsubscribeProfile = onSnapshot(profileRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        setProfile(prev => ({ ...prev, ...data }));
        
        if (!data.isConfigured) {
          setAppPhase('setup');
        } else {
          setAppPhase('dashboard');
        }

        if (data.startDate && Object.keys(daysData).length === 0) {
          const start = new Date(data.startDate);
          const now = new Date();
          const diff = Math.floor((now - start) / (1000 * 60 * 60 * 24));
          setCurrentDayIndex(Math.max(0, Math.min(74, diff)));
        }
      }
      setLoading(false);
    }, (error) => console.error("Profile fetch error:", error));

    const daysCol = collection(db, 'artifacts', appId, 'users', activeProfileId, 'days');
    const unsubscribeDays = onSnapshot(daysCol, (snapshot) => {
      const data = {};
      snapshot.forEach(d => { data[d.id] = d.data(); });
      setDaysData(data);
    }, (error) => console.error("Days fetch error:", error));

    return () => { unsubscribeProfile(); unsubscribeDays(); };
  }, [user, activeProfileId]);

  // (3) Weather
  useEffect(() => {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(async (pos) => {
      try {
        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true&temperature_unit=fahrenheit`);
        const data = await response.json();
        setWeather(data.current_weather);
      } catch (e) { console.error("Weather error:", e); }
    });
  }, []);

  // --- ACTIONS ---
  const handleProfileAuth = async () => {
    if (!usernameInput.trim() || !passwordInput.trim()) {
      setAuthStatus({ message: "Username and Password are required.", type: "error" });
      return;
    }
    if (passwordInput.length < 4) {
       setAuthStatus({ message: "Password must be 4+ characters.", type: "error" });
       return;
    }

    const targetId = usernameInput.trim().toLowerCase(); 
    const profileRef = doc(db, 'artifacts', appId, 'users', targetId, 'profile', 'data');
    
    try {
      const docSnap = await getDoc(profileRef);
      if (docSnap.exists()) {
        // RETURNING USER: Login
        const existingData = docSnap.data();
        if (existingData.passcode === passwordInput.trim()) {
          await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'session_link'), { activeProfileId: targetId });
          setActiveProfileId(targetId);
        } else {
          setAuthStatus({ message: "Username taken. Incorrect password.", type: "error" });
        }
      } else {
        // NEW USER: Create Account
        const newProfile = { 
          ...profile, 
          passcode: passwordInput.trim(), 
          isConfigured: false,
          startDate: new Date().toISOString().split('T')[0]
        };
        await setDoc(profileRef, newProfile);
        await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'session_link'), { activeProfileId: targetId });
        setActiveProfileId(targetId);
      }
    } catch (err) {
      setAuthStatus({ message: "Connection error. Please try again.", type: "error" });
    }
  };

  const handleSignOut = async () => {
    if (confirm("Sign out? This will clear the session on this device.")) {
      await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'session_link'), { activeProfileId: null });
      setActiveProfileId(null);
      setAppPhase('auth');
      window.location.reload();
    }
  };

  const finalizeSetup = async () => {
    if (!profile.dietDescription.trim()) {
      setAuthStatus({ message: "Please define your diet protocol first.", type: "error" });
      return;
    }
    await updateProfile({ isConfigured: true });
    setAppPhase('dashboard');
  };

  const updateDayData = async (dayIdx, updates) => {
    if (!user || !activeProfileId) return;
    const dayId = `day-${dayIdx + 1}`;
    try {
      await setDoc(doc(db, 'artifacts', appId, 'users', activeProfileId, 'days', dayId), {
        ...daysData[dayId], ...updates, day: dayIdx + 1, lastUpdated: new Date().toISOString()
      }, { merge: true });
      if (updates.weight) await updateProfile({ currentWeight: updates.weight });
    } catch (err) { console.error("Update error:", err); }
  };

  const updateProfile = async (updates) => {
    if (!user || !activeProfileId) return;
    try {
      await setDoc(doc(db, 'artifacts', appId, 'users', activeProfileId, 'profile', 'data'), updates, { merge: true });
    } catch (err) { console.error("Profile update error:", err); }
  };

  const applyProgramPreset = async (type) => {
    if (!user || !activeProfileId) return;
    let updates = { programType: type };
    if (type === 'hard_classic') {
      updates = { ...updates, workoutCount: 2, workoutMins: 45, outdoorRequired: true, targetWaterOz: 128, consumptionType: 'reading', consumptionGoal: 10, dietRequired: true, photoRequired: true, photoTitle: 'Progress Photo', alcoholRequired: true, alcoholLimit: 0 };
    } else if (type === 'medium') {
      updates = { ...updates, workoutCount: 1, workoutMins: 45, outdoorRequired: false, targetWaterOz: 128, consumptionType: 'reading', consumptionGoal: 10, dietRequired: true, photoRequired: true, photoTitle: 'Progress Photo', alcoholRequired: true, alcoholLimit: 0 };
    } else if (type === 'soft') {
      updates = { ...updates, workoutCount: 1, workoutMins: 30, outdoorRequired: false, targetWaterOz: 64, consumptionType: 'reading', consumptionGoal: 5, dietRequired: true, photoRequired: false, alcoholRequired: false, alcoholLimit: 7 };
    }
    await updateProfile(updates);
  };

  const handlePhotoUpload = async (e) => {
    const file = e.target.files?.[0];
    if (!file || !user || !activeProfileId) return;
    setIsUploading(true);
    const reader = new FileReader();
    reader.onloadend = async () => {
      const base64String = reader.result;
      const dayId = `day-${currentDayIndex + 1}`;
      const existingTasks = daysData[dayId]?.tasks || {};
      await updateDayData(currentDayIndex, { photoData: base64String, tasks: { ...existingTasks, photo: true } });
      setIsUploading(false);
    };
    reader.readAsDataURL(file);
  };

  const checkDayComplete = (dayInfo) => {
    if (!dayInfo) return false;
    const t = dayInfo.tasks || {};
    const waterMet = (dayInfo.waterOz || 0) >= (profile.targetWaterOz || 128);
    const w1 = t.workout1 === true;
    const w2 = profile.workoutCount === 2 ? t.workout2 === true : true;
    const diet = profile.dietRequired ? t.diet === true : true;
    const reading = t.consumption === true;
    const photo = profile.photoRequired ? t.photo === true : true;
    const alcohol = profile.alcoholRequired ? t.alcohol === true : true;
    return waterMet && w1 && w2 && diet && reading && photo && alcohol;
  };

  const totals = useMemo(() => {
    let totalMins = 0; let completedCount = 0; let uniqueItems = new Set();
    Object.values(daysData).forEach(day => {
      const mins = (parseInt(day.workout1_mins || 0) + (parseInt(day.workout1_hrs || 0) * 60)) + (parseInt(day.workout2_mins || 0) + (parseInt(day.workout2_hrs || 0) * 60));
      totalMins += mins;
      if (checkDayComplete(day)) completedCount++;
      if (day.consumptionTitle?.trim()) uniqueItems.add(day.consumptionTitle.trim());
    });
    const weightLost = (profile.startWeight && profile.currentWeight) ? (parseFloat(profile.startWeight) - parseFloat(profile.currentWeight)).toFixed(1) : '0.0';
    return { hours: Math.floor(totalMins / 60), mins: totalMins % 60, completedDays: completedCount, uniqueItems: Array.from(uniqueItems), weightLost };
  }, [daysData, profile]);

  const weightTrendData = useMemo(() => {
    return Object.entries(daysData).map(([id, d]) => ({ day: d.day, weight: parseFloat(d.weight) })).filter(d => !isNaN(d.weight)).sort((a, b) => a.day - b.day);
  }, [daysData]);

  if (loading) return <div className="flex flex-col items-center justify-center h-screen bg-slate-950 text-orange-500 font-black uppercase tracking-widest gap-4">
    <div className="w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin" />
    Syncing Mastery Hub...
  </div>;

  // --- PHASE 1: AUTH ---
  if (appPhase === 'auth') {
    return (
      <div className="min-h-screen bg-slate-950 flex items-center justify-center p-6 text-slate-100 font-sans">
        <div className="max-w-md w-full space-y-8">
           <div className="text-center space-y-2">
             <div className="inline-block p-4 bg-orange-500 rounded-3xl text-white shadow-2xl shadow-orange-500/20 mb-4 animate-bounce">
               <Trophy className="w-10 h-10" />
             </div>
             <h1 className="text-4xl font-black tracking-tighter uppercase text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-rose-600">75 Mastery</h1>
             <p className="text-xs text-slate-500 font-bold uppercase tracking-widest">Consistency Infrastructure</p>
           </div>

           <div className="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-2xl space-y-6">
              <div className="space-y-4">
                <div className="relative">
                  <UserIcon className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-600" />
                  <input type="text" className="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 pl-12 text-white outline-none focus:border-indigo-500 font-bold" placeholder="Username" value={usernameInput} onChange={(e) => setUsernameInput(e.target.value)} />
                </div>
                <div className="relative">
                  <KeyRound className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-600" />
                  <input type="password" className="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 pl-12 text-white outline-none focus:border-indigo-500 font-bold" placeholder="Password" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} />
                </div>
              </div>

              {authStatus.message && (
                <div className={`p-4 rounded-2xl text-xs font-black uppercase tracking-widest flex items-center gap-2 ${authStatus.type === 'error' ? 'bg-rose-500/10 text-rose-500 border border-rose-500/20' : 'bg-green-500/10 text-green-500 border border-green-500/20'}`}>
                  <AlertCircle className="w-4 h-4" /> {authStatus.message}
                </div>
              )}

              <button onClick={handleProfileAuth} className="w-full bg-indigo-500 p-5 rounded-2xl text-white font-black uppercase tracking-widest shadow-xl shadow-indigo-500/20 active:scale-95 transition-all flex items-center justify-center gap-2 text-sm">
                Login or Create Account <ArrowRight className="w-4 h-4" />
              </button>

              <div className="pt-4 border-t border-slate-800">
                 <div className="flex gap-2 text-slate-500">
                    <AlertCircle className="w-8 h-8 text-amber-500 shrink-0" />
                    <p className="text-[10px] leading-relaxed font-medium uppercase italic">
                      <span className="text-amber-400 font-black">Shared Device Disclaimer:</span> If you are on a public computer, always sign out before closing to protect your data and photos.
                    </p>
                 </div>
              </div>
           </div>
        </div>
      </div>
    );
  }

  // Common Dashboard Variables
  const dayKey = `day-${currentDayIndex + 1}`;
  const currentDayData = daysData[dayKey] || { tasks: {}, waterOz: 0, workout1_desc: '', workout2_desc: '', workout1_hrs: '', workout1_mins: '', workout2_hrs: '', workout2_mins: '', notes: '', consumptionTitle: '', photoData: null, weight: '' };
  const waterDone = (currentDayData.waterOz || 0) >= (profile.targetWaterOz || 128);
  const progressPercent = Math.round((totals.completedDays / 75) * 100);

  const w1TotalMins = (parseInt(currentDayData.workout1_hrs) || 0) * 60 + (parseInt(currentDayData.workout1_mins) || 0);
  const w2TotalMins = (parseInt(currentDayData.workout2_hrs) || 0) * 60 + (parseInt(currentDayData.workout2_mins) || 0);
  const w1Qualifies = w1TotalMins >= profile.workoutMins;
  const w2Qualifies = w2TotalMins >= profile.workoutMins;

  const pillars = [
    { id: 'workout1', label: profile.outdoorRequired ? 'Outdoor Workout' : 'Workout One', icon: <Dumbbell className="w-5 h-5" />, sub: `${profile.workoutMins} Min Req`, qualifies: w1Qualifies },
    ...(profile.workoutCount === 2 ? [{ id: 'workout2', label: 'Workout Two', icon: <Dumbbell className="w-5 h-5" />, sub: `${profile.workoutMins} Min Req`, qualifies: w2Qualifies }] : []),
    { id: 'consumption', label: profile.programType === 'hard_classic' ? 'Book Reading' : (profile.consumptionType === 'reading' ? 'Book Reading' : 'Listen to Podcast'), icon: profile.consumptionType === 'reading' ? <BookOpen className="w-5 h-5" /> : <Mic className="w-5 h-5" />, sub: `Goal: ${profile.consumptionGoal} ${profile.consumptionType === 'reading' ? 'Pages' : 'Mins'}` },
    ...(profile.photoRequired ? [{ id: 'photo', label: profile.photoTitle || 'Visual Progress', icon: <Camera className="w-5 h-5" />, sub: 'Daily Selfie' }] : []),
    { id: 'diet', label: 'Follow a Diet', icon: <Utensils className="w-5 h-5" />, sub: profile.programType === 'hard_classic' ? `${profile.dietDescription || 'Standard'} • No Cheats` : (profile.dietDescription || 'No Cheats') },
    ...(profile.alcoholRequired ? [{ id: 'alcohol', label: profile.alcoholLimit === 0 ? 'No Alcohol' : 'Alcohol within Limit', icon: <Beer className="w-5 h-5" />, sub: profile.alcoholLimit === 0 ? 'Zero Tolerance' : `Max ${profile.alcoholLimit} drinks / week` }] : [])
  ];

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 font-sans pb-32">
      {/* Header */}
      <header className="p-6 bg-slate-900 border-b border-slate-800 sticky top-0 z-40">
        <div className="flex justify-between items-start mb-6">
          <div>
            <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-rose-600 tracking-tighter uppercase leading-none">75 Mastery</h1>
            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-2 flex items-center gap-1">
               <ShieldCheck className="w-3 h-3 text-green-500" /> Profil: {activeProfileId}
            </p>
          </div>
          {weather && (
            <div className="text-right bg-slate-800 p-2 rounded-xl border border-slate-700">
              <div className="flex items-center gap-1 text-orange-400 font-bold text-sm"><Thermometer className="w-3 h-3" /> {Math.round(weather.temperature)}°F</div>
              <div className="text-[10px] text-slate-400 uppercase font-black">Weather</div>
            </div>
          )}
        </div>
        <div className="relative h-3 bg-slate-800 rounded-full overflow-hidden mb-2 shadow-inner">
          <div className="absolute h-full bg-gradient-to-r from-orange-500 to-rose-500 transition-all duration-1000" style={{ width: `${progressPercent}%` }} />
        </div>
        <div className="flex justify-between text-[10px] font-black text-slate-500 uppercase tracking-tighter">
          <span>{progressPercent}% Mastery</span>
          <span>Day {totals.completedDays} Wins</span>
        </div>
      </header>

      {appPhase === 'dashboard' && (
        <nav className="flex px-4 py-2 gap-2 bg-slate-950 sticky top-[138px] z-30 shadow-2xl border-b border-slate-900 overflow-x-auto scrollbar-hide">
          <button onClick={() => setActiveTab('today')} className={`flex-1 min-w-[90px] py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex flex-col items-center gap-1 ${activeTab === 'today' ? 'bg-orange-500 text-white shadow-lg shadow-orange-500/30' : 'text-slate-400 hover:bg-slate-900'}`}><Calendar className="w-4 h-4" /> Daily</button>
          <button onClick={() => setActiveTab('gallery')} className={`flex-1 min-w-[90px] py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex flex-col items-center gap-1 ${activeTab === 'gallery' ? 'bg-orange-500 text-white' : 'text-slate-400 hover:bg-slate-900'}`}><LayoutGrid className="w-4 h-4" /> Gallery</button>
          <button onClick={() => setActiveTab('stats')} className={`flex-1 min-w-[90px] py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex flex-col items-center gap-1 ${activeTab === 'stats' ? 'bg-orange-500 text-white' : 'text-slate-400 hover:bg-slate-900'}`}><TrendingUp className="w-4 h-4" /> Stats</button>
          <button onClick={() => setActiveTab('setup')} className={`flex-1 min-w-[90px] py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex flex-col items-center gap-1 ${activeTab === 'setup' ? 'bg-orange-500 text-white' : 'text-slate-400 hover:bg-slate-900'}`}><Settings className="w-4 h-4" /> Setup</button>
        </nav>
      )}

      <main className="p-4 max-w-lg mx-auto space-y-6">
        {/* PHASE 2: SETUP (Mandatory for new profiles) */}
        {appPhase === 'setup' && (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-700">
             <div className="p-6 bg-indigo-500/10 border border-indigo-500/30 rounded-[2.5rem] text-center space-y-4">
                <Target className="w-12 h-12 text-indigo-400 mx-auto" />
                <h2 className="text-2xl font-black uppercase tracking-tight leading-none">Program Configuration</h2>
                <p className="text-xs text-indigo-300 font-bold uppercase tracking-widest leading-relaxed">
                  Finalize your mastery rules to unlock your dashboard.
                </p>
             </div>
             
             <div className="bg-slate-900 p-6 rounded-[2.5rem] border border-slate-800 shadow-xl space-y-6">
                <div className="p-4 bg-slate-800/20 rounded-2xl border border-slate-800">
                  <label className="block text-[10px] font-black text-slate-500 uppercase mb-2">Preset Mode</label>
                  <select className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none font-bold" value={profile.programType} onChange={(e) => applyProgramPreset(e.target.value)}>
                    <option value="hard_classic">75 Hard (Classic Rules)</option>
                    <option value="medium">75 Medium</option>
                    <option value="soft">75 Soft</option>
                    <option value="custom">Fully Custom</option>
                  </select>
                </div>
                <div><label className="block text-[10px] font-black text-slate-500 uppercase mb-2">Program Start Date</label><input type="date" className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none" value={profile.startDate} onChange={(e) => updateProfile({ startDate: e.target.value })} /></div>
                <div><label className="block text-[10px] font-black text-slate-500 uppercase mb-2">Diet Description (Required)</label><input type="text" className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none" placeholder="e.g. Keto, IF" value={profile.dietDescription} onChange={(e) => updateProfile({ dietDescription: e.target.value })} /></div>
                <div><label className="block text-[10px] font-black text-slate-500 uppercase mb-2">The Big "Why" (Required)</label><textarea className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none h-24 italic" placeholder="My reason for mastery..." value={profile.intentions} onChange={(e) => updateProfile({ intentions: e.target.value })} /></div>
                
                {authStatus.message && (
                  <div className="p-3 bg-rose-500/10 text-rose-500 rounded-xl text-[10px] font-bold uppercase text-center">{authStatus.message}</div>
                )}

                <button onClick={finalizeSetup} className="w-full bg-orange-500 p-5 rounded-2xl text-white font-black uppercase tracking-widest text-sm shadow-xl shadow-orange-500/20 active:scale-95 transition-all">
                  Launch Challenge
                </button>
             </div>
          </div>
        )}

        {/* PHASE 3: DASHBOARD */}
        {appPhase === 'dashboard' && activeTab === 'today' && (
          <>
            {profile.intentions && <div className="p-4 bg-orange-500/5 border border-orange-500/20 rounded-2xl text-center italic text-sm text-orange-200/70 shadow-lg italic">"{profile.intentions}"</div>}
            
            <div className="flex items-center justify-between bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-xl">
              <button onClick={() => setCurrentDayIndex(Math.max(0, currentDayIndex - 1))} className="p-2 text-slate-500 hover:text-orange-500 transition-colors"><ChevronLeft /></button>
              <div className="text-center">
                <h2 className="text-xl font-black uppercase tracking-tighter">DAY {currentDayIndex + 1}</h2>
                <p className="text-[10px] text-orange-500 font-bold uppercase tracking-widest">{new Date(new Date(profile.startDate).getTime() + currentDayIndex * 86400000).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</p>
              </div>
              <button onClick={() => setCurrentDayIndex(Math.min(74, currentDayIndex + 1))} className="p-2 text-slate-500 hover:text-orange-500 transition-colors"><ChevronRight /></button>
            </div>

            {/* Water Tracker */}
            <div className={`p-5 rounded-3xl border transition-all duration-500 shadow-xl ${waterDone ? 'bg-cyan-500/10 border-cyan-500/50 shadow-cyan-500/5' : 'bg-slate-900 border-slate-800'}`}>
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-2"><div className={`p-2 rounded-lg ${waterDone ? 'bg-cyan-500 text-white shadow-lg' : 'bg-cyan-500/20 text-cyan-400'}`}><Droplets className="w-5 h-5" /></div><h3 className="font-black text-sm uppercase tracking-wider">Hydration</h3></div>
                <div className="text-right flex items-center gap-2 font-black"><input type="number" className={`bg-slate-950 border border-slate-800 px-2 py-1 rounded w-16 text-center outline-none focus:border-cyan-500 ${waterDone ? 'text-cyan-400' : 'text-slate-100'}`} value={currentDayData.waterOz || 0} onChange={(e) => updateDayData(currentDayIndex, { waterOz: parseInt(e.target.value) || 0 })} /><span className="text-xs text-slate-500 uppercase tracking-tighter">/ {profile.targetWaterOz} OZ</span></div>
              </div>
              <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                {[8, 16, 24, 32].map(oz => (<button key={oz} onClick={() => updateDayData(currentDayIndex, { waterOz: (currentDayData.waterOz || 0) + oz })} className="bg-slate-800 border border-slate-700 px-4 py-2 rounded-xl text-xs font-bold text-slate-300 active:bg-cyan-500 transition-all active:scale-95">+{oz}oz</button>))}
              </div>
            </div>

            {/* Pillar List */}
            <div className="space-y-4">
              {pillars.map(p => {
                const done = currentDayData.tasks?.[p.id];
                if (p.id.startsWith('workout')) {
                   const color = p.id === 'workout1' ? 'orange' : 'blue';
                   return (
                    <div key={p.id} className={`p-5 rounded-3xl border transition-all duration-300 ${done ? `bg-${color}-500/10 border-${color}-500/50 shadow-inner shadow-black/20` : 'bg-slate-900 border-slate-800 shadow-xl'}`}>
                      <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center gap-2"><div className={`p-2 rounded-lg ${done ? `bg-${color}-500 text-white` : 'bg-slate-800 text-slate-500'}`}>{p.icon}</div><div><h3 className={`font-black text-sm uppercase tracking-wider ${done ? 'text-slate-100' : 'text-slate-300'}`}>{p.label}</h3><p className="text-[10px] text-slate-500 font-bold uppercase">{p.sub}</p></div></div>
                        <div className="flex gap-1">
                          <input type="number" className="w-10 bg-slate-950 border border-slate-800 rounded px-1 text-center font-bold text-white outline-none" placeholder="H" value={currentDayData[`${p.id}_hrs`] || ''} onChange={(e) => updateDayData(currentDayIndex, { [`${p.id}_hrs`]: e.target.value })} />
                          <span className="text-slate-600 font-bold">:</span>
                          <input type="number" className="w-10 bg-slate-950 border border-slate-800 rounded px-1 text-center font-bold text-white outline-none" placeholder="M" value={currentDayData[`${p.id}_mins`] || ''} onChange={(e) => updateDayData(currentDayIndex, { [`${p.id}_mins`]: e.target.value })} />
                        </div>
                      </div>
                      <textarea className="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-sm text-slate-300 outline-none h-20 mb-3" placeholder="Notes..." value={currentDayData[`${p.id}_desc`] || ''} onChange={(e) => updateDayData(currentDayIndex, { [`${p.id}_desc`]: e.target.value })} />
                      <div className="flex items-center gap-3">
                        <div className="flex-1">
                          {done ? (
                            <div className="w-full py-3 rounded-xl font-black text-xs uppercase border border-slate-700 bg-slate-800 text-slate-400 flex items-center justify-center gap-2 cursor-default"><CheckCircle2 className="w-4 h-4 text-green-500" /> Workout Logged</div>
                          ) : (
                            <button disabled={!p.qualifies} onClick={() => updateDayData(currentDayIndex, { tasks: { ...currentDayData.tasks, [p.id]: true }})} className={`w-full py-3 rounded-xl font-black text-xs uppercase border transition-all ${p.qualifies ? `bg-${color}-500 border-${color}-400 text-white shadow-lg` : 'bg-slate-950 border-slate-800 text-slate-700 cursor-not-allowed'}`}>
                              {p.qualifies ? 'Log Workout' : 'Min Not Met'}
                            </button>
                          )}
                        </div>
                        {done && <button onClick={() => updateDayData(currentDayIndex, { tasks: { ...currentDayData.tasks, [p.id]: false }})} className="p-3 bg-slate-800 border border-slate-700 rounded-xl text-slate-500"><Undo2 className="w-4 h-4" /></button>}
                      </div>
                    </div>
                   );
                }
                
                if (p.id === 'consumption') {
                  return (
                    <div key={p.id} className={`p-5 rounded-3xl border transition-all duration-300 ${done ? 'bg-purple-500/10 border-purple-500/50 shadow-inner' : 'bg-slate-900 border-slate-800 shadow-xl'}`}>
                      <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2">
                          <div className={`p-2 rounded-lg ${done ? 'bg-purple-500 text-white shadow-lg' : 'bg-purple-500/20 text-purple-400'}`}>{p.icon}</div>
                          <h3 className="font-black text-sm uppercase tracking-wider">{p.label}</h3>
                        </div>
                        <button onClick={() => updateDayData(currentDayIndex, { tasks: { ...currentDayData.tasks, consumption: !currentDayData.tasks?.consumption }})} className={`px-4 py-2 rounded-xl font-black text-[10px] uppercase border transition-all ${done ? 'bg-purple-500 border-purple-400 text-white' : 'bg-slate-800 border-slate-700 text-slate-500'}`}>
                          {done ? 'Done' : 'Mark Done'}
                        </button>
                      </div>
                      <input type="text" className="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-sm text-slate-300 outline-none focus:border-purple-500" placeholder="Title..." value={currentDayData.consumptionTitle || ''} onChange={(e) => updateDayData(currentDayIndex, { consumptionTitle: e.target.value })} />
                    </div>
                  );
                }

                if (p.id === 'photo') {
                  return (
                    <div key={p.id} className={`p-5 rounded-3xl border transition-all duration-300 ${done ? 'bg-pink-500/10 border-pink-500/50 shadow-inner' : 'bg-slate-900 border-slate-800 shadow-xl'}`}>
                      <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2">
                          <div className={`p-2 rounded-lg ${done ? 'bg-pink-500 text-white' : 'bg-pink-500/20 text-pink-500'}`}>{p.icon}</div>
                          <h3 className="font-black text-sm uppercase tracking-wider">{p.label}</h3>
                        </div>
                        {currentDayData.photoData && <button onClick={removePhoto} className="p-2 bg-red-500/10 text-red-500 rounded-lg hover:bg-red-500/20 transition-all"><X className="w-4 h-4" /></button>}
                      </div>
                      <div onClick={() => fileInputRef.current?.click()} className={`relative aspect-video rounded-2xl border-2 border-dashed transition-all flex flex-col items-center justify-center overflow-hidden cursor-pointer ${currentDayData.photoData ? 'border-pink-500/50' : 'border-slate-800 bg-slate-800/20 hover:border-pink-500/30'}`}>
                        {currentDayData.photoData ? <img src={currentDayData.photoData} alt="Progress" className="w-full h-full object-cover" /> : <div className="flex flex-col items-center text-slate-500">{isUploading ? <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500" /> : <><Upload className="w-8 h-8 mb-2" /><span className="text-xs font-black uppercase tracking-widest">Capture Win</span></>}</div>}
                        <input type="file" ref={fileInputRef} onChange={handlePhotoUpload} accept="image/*" className="hidden" />
                      </div>
                    </div>
                  );
                }

                if (p.id === 'diet' || p.id === 'alcohol') {
                  const color = p.id === 'diet' ? 'green' : 'amber';
                  return (
                    <button key={p.id} onClick={() => updateDayData(currentDayIndex, { tasks: { ...currentDayData.tasks, [p.id]: !currentDayData.tasks?.[p.id] }})} className={`w-full flex items-center p-5 rounded-3xl border transition-all ${done ? `bg-${color}-500/10 border-${color}-500/50 shadow-inner` : 'bg-slate-900 border-slate-800 shadow-xl'}`}>
                      <div className={`p-2 rounded-lg mr-4 ${done ? `bg-${color}-500 text-white shadow-md` : `bg-${color}-500/20 text-${color}-500`}`}>{p.icon}</div>
                      <div className="flex-1 text-left">
                        <span className="block font-black text-sm uppercase tracking-wider">{p.label}</span>
                        <span className="text-[10px] text-slate-500 font-bold uppercase">{p.sub}</span>
                      </div>
                      {done ? <CheckCircle2 className={`text-${color}-500 w-5 h-5`} /> : <Circle className="text-slate-700 w-5 h-5" />}
                    </button>
                  );
                }
                return null;
              })}
            </div>
          </>
        )}

        {appPhase === 'dashboard' && activeTab === 'gallery' && (
          <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-2xl">
            <div className="flex items-center justify-between mb-6"><h3 className="text-lg font-black flex items-center gap-2"><ImageIcon className="text-pink-500" /> Evolution Gallery</h3><span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">{totals.completedDays} Wins</span></div>
            <div className="grid grid-cols-3 sm:grid-cols-4 gap-3">
              {Array.from({ length: 75 }).map((_, i) => {
                const dKey = `day-${i + 1}`;
                const info = daysData[dKey];
                const isComp = checkDayComplete(info);
                return <button key={i} onClick={() => { setCurrentDayIndex(i); setActiveTab('today'); }} className={`aspect-square relative rounded-xl border transition-all overflow-hidden flex flex-col items-center justify-center ${i === currentDayIndex ? 'border-orange-500 ring-2 ring-orange-500/20' : 'border-slate-800 bg-slate-800/30'}`}>{info?.photoData ? <img src={info.photoData} className="w-full h-full object-cover" /> : <div className="text-[8px] font-black text-slate-700 uppercase">Day {i+1}</div>}{isComp && <div className="absolute top-1 right-1 w-3 h-3 bg-orange-500 rounded-full border-2 border-slate-900 z-10" />}</button>;
              })}
            </div>
          </div>
        )}

        {appPhase === 'dashboard' && activeTab === 'stats' && (
          <div className="space-y-6">
            <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl overflow-hidden relative">
              <div className="absolute top-0 right-0 w-48 h-48 bg-orange-500/5 blur-3xl -mr-24 -mt-24" />
              <h3 className="text-lg font-black mb-2 flex items-center gap-2 uppercase tracking-tight"><Activity className="w-5 h-5 text-orange-500" /> Progress Trend</h3>
              <WeightChart data={weightTrendData} />
              <div className="grid grid-cols-2 gap-4 mt-6">
                <div className="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50 text-center"><p className="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Weight Loss</p><p className="text-2xl font-black text-green-400">-{totals.weightLost} LBS</p></div>
                <div className="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50 text-center"><p className="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Total Effort</p><p className="text-2xl font-black text-cyan-400">{totals.hours}h {totals.mins}m</p></div>
              </div>
            </div>

            <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl">
              <h3 className="text-lg font-black mb-6 flex items-center gap-2"><Ruler className="w-5 h-5 text-orange-500" /> Body Snapshot</h3>
              <div className="grid grid-cols-2 gap-3 mb-6">
                <div className="relative"><label className="text-[9px] font-black text-slate-600 uppercase absolute top-2 left-3">Start</label><input type="number" step="0.1" className="w-full bg-slate-950 border border-slate-800 pt-6 pb-2 px-3 rounded-xl text-white font-bold outline-none" value={profile.startWeight} onChange={(e) => updateProfile({ startWeight: e.target.value })} /></div>
                <div className="relative"><label className="text-[9px] font-black text-slate-600 uppercase absolute top-2 left-3">Latest</label><input type="number" disabled className="w-full bg-slate-900/50 border border-slate-800 pt-6 pb-2 px-3 rounded-xl text-slate-500 font-bold" value={profile.currentWeight} /></div>
              </div>
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                {Object.keys(profile.measurements).map(key => (
                  <div key={key} className="relative"><label className="text-[9px] font-black text-slate-600 uppercase absolute top-2 left-3 tracking-tighter">{key}</label><input type="number" step="0.1" className="w-full bg-slate-950 border border-slate-800 pt-6 pb-2 px-3 rounded-xl text-white font-bold outline-none" value={profile.measurements[key]} onChange={(e) => updateProfile({ measurements: { ...profile.measurements, [key]: e.target.value }})} /></div>
                ))}
              </div>
            </div>

            <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl border-t-orange-500/20">
              <h3 className="text-lg font-black mb-4 flex items-center gap-2"><Scale className="w-5 h-5 text-orange-500" /> Manual Weight Log</h3>
              <div className="flex gap-2">
                <input type="number" step="0.1" className="flex-1 bg-slate-950 border border-slate-800 p-3 rounded-xl text-white font-bold outline-none" placeholder="Enter weight..." value={newWeight} onChange={(e) => setNewWeight(e.target.value)} />
                <button onClick={() => { const idx = Math.max(0, Math.floor((new Date() - new Date(profile.startDate)) / 86400000)); updateDayData(idx, { weight: newWeight }); setNewWeight(''); }} className="bg-orange-500 text-white font-black px-6 rounded-xl text-xs uppercase tracking-widest shadow-lg">Log</button>
              </div>
            </div>
          </div>
        )}

        {appPhase === 'dashboard' && activeTab === 'setup' && (
          <div className="space-y-6">
            {/* User Session Management */}
            <div className="bg-gradient-to-br from-indigo-950 to-slate-900 p-6 rounded-3xl border border-indigo-500/30 shadow-xl relative overflow-hidden">
               <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-500/10 blur-3xl -mr-16 -mt-16" />
               <div className="flex items-center gap-3 mb-6">
                  <div className="p-3 bg-indigo-500 rounded-2xl text-white shadow-lg"><UserIcon className="w-6 h-6" /></div>
                  <div><h3 className="text-lg font-black tracking-tight uppercase leading-none">Mastery Session</h3><p className="text-[9px] text-indigo-400 font-bold uppercase tracking-widest mt-1">Synced to Cloud</p></div>
               </div>
               <div className="bg-slate-950/50 rounded-2xl p-4 border border-slate-800 mb-4">
                  <p className="text-[9px] font-black text-slate-500 uppercase mb-2">Logged in as</p>
                  <p className="text-sm font-mono text-indigo-300 break-all uppercase tracking-widest font-bold">{activeProfileId}</p>
               </div>
               <button onClick={handleSignOut} className="w-full bg-slate-800 border border-slate-700 p-4 rounded-2xl text-rose-500 font-black uppercase tracking-widest text-[10px] flex items-center justify-center gap-2 hover:bg-rose-500/10 transition-all">
                 <LogOut className="w-4 h-4" /> Sign Out / Switch User
               </button>
            </div>

            <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl">
              <h3 className="text-lg font-black mb-4 flex items-center gap-2 text-orange-400"><Target className="w-5 h-5" /> Mastery Settings</h3>
              <div className="space-y-6">
                <div className="p-4 bg-slate-800/20 rounded-2xl border border-slate-800">
                  <label className="block text-[10px] font-black text-slate-500 uppercase mb-2">Program Preset</label>
                  <select className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none font-bold" value={profile.programType} onChange={(e) => applyProgramPreset(e.target.value)}>
                    <option value="hard_classic">75 Hard (Classic Rules)</option>
                    <option value="medium">75 Medium</option>
                    <option value="soft">75 Soft</option>
                    <option value="custom">Fully Custom</option>
                  </select>
                </div>
                <div><label className="block text-[10px] font-black text-slate-500 uppercase mb-2">Program Start Date</label><input type="date" className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none" value={profile.startDate} onChange={(e) => updateProfile({ startDate: e.target.value })} /></div>
                <div className="p-4 bg-slate-800/20 rounded-2xl border border-slate-800 space-y-4">
                  <h4 className="text-[10px] font-black text-slate-500 uppercase border-b border-slate-800 pb-2 flex items-center gap-2 tracking-widest"><Dumbbell className="w-3 h-3" /> Workouts</h4>
                  <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-[10px] text-slate-500 uppercase mb-2">Daily Count</label><select disabled={profile.programType === 'hard_classic'} className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none disabled:opacity-50" value={profile.workoutCount} onChange={(e) => updateProfile({ workoutCount: parseInt(e.target.value) })}><option value={1}>1</option><option value={2}>2</option></select></div>
                    <div><label className="block text-[10px] text-slate-500 uppercase mb-2">Min Minutes</label><input disabled={profile.programType === 'hard_classic'} type="number" className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none disabled:opacity-50 font-bold" value={profile.workoutMins} onChange={(e) => updateProfile({ workoutMins: parseInt(e.target.value) })} /></div>
                  </div>
                </div>
                <div className="p-4 bg-slate-800/20 rounded-2xl border border-slate-800 space-y-4">
                  <h4 className="text-[10px] font-black text-slate-500 uppercase border-b border-slate-800 pb-2 flex items-center gap-2 tracking-widest"><Utensils className="w-3 h-3" /> Nutrition</h4>
                  <div><label className="block text-[10px] text-slate-500 uppercase mb-2">Diet Goal</label><input type="text" className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none" placeholder="e.g. Keto" value={profile.dietDescription} onChange={(e) => updateProfile({ dietDescription: e.target.value })} /></div>
                </div>
                <div><label className="block text-[10px] font-black text-slate-500 uppercase mb-2">Your Big "Why"</label><textarea className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white outline-none focus:border-orange-500 h-24 italic" value={profile.intentions} onChange={(e) => updateProfile({ intentions: e.target.value })} /></div>
              </div>
            </div>
          </div>
        )}
      </main>

      {appPhase === 'dashboard' && (
        <footer className="fixed bottom-0 left-0 right-0 bg-slate-900/90 backdrop-blur-xl border-t border-slate-800 px-6 py-4 flex justify-around items-center z-50 shadow-[0_-10px_20px_rgba(0,0,0,0.5)]">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-slate-800 rounded-full shadow-lg border border-slate-700"><Trophy className={`w-5 h-5 ${totals.completedDays > 0 ? 'text-orange-500 animate-pulse' : 'text-slate-500'}`} /></div>
            <div><p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Consistency</p><p className="text-lg font-black text-white">{totals.completedDays} Wins</p></div>
          </div>
          <div className="text-right">
            <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Effort</p>
            <p className="text-lg font-black text-cyan-400">{totals.hours}h <span className="text-[10px] uppercase text-slate-500 font-bold">Total</span></p>
          </div>
        </footer>
      )}
    </div>
  );
}