<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>75 Mastery Hub</title>
  <!-- PWA / App-like install -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#020617" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="75 Mastery" />

  <!-- Recommended icons -->
  <link rel="icon" href="/icon-192.png" />
  <link rel="apple-touch-icon" href="/icon-192.png" />

  <!-- Tailwind config (must come BEFORE tailwindcdn) -->
  <script>
    // Safelist dynamic classes used via template strings (bg-${theme}-..., border-${theme}-..., text-${theme}-...)
    tailwind = {
      config: {
        safelist: [
          // gradients
          'bg-gradient-to-r', 'bg-gradient-to-br',
          'from-orange-500/20','to-orange-500/5',
          'from-blue-500/20','to-blue-500/5',
          'from-purple-500/20','to-purple-500/5',
          'from-pink-500/20','to-pink-500/5',
          'from-green-500/20','to-green-500/5',
          'from-amber-500/20','to-amber-500/5',

          // bg
          'bg-orange-500','bg-blue-500','bg-purple-500','bg-pink-500','bg-green-500','bg-amber-500',
          'bg-orange-600','bg-blue-600','bg-purple-600','bg-pink-600','bg-green-600','bg-amber-600',
          'bg-orange-500/20','bg-blue-500/20','bg-purple-500/20','bg-pink-500/20','bg-green-500/20','bg-amber-500/20',
          'bg-orange-500/10','bg-blue-500/10','bg-purple-500/10','bg-pink-500/10','bg-green-500/10','bg-amber-500/10',
          'bg-orange-500/5','bg-blue-500/5','bg-purple-500/5','bg-pink-500/5','bg-green-500/5','bg-amber-500/5',

          // border
          'border-orange-500','border-blue-500','border-purple-500','border-pink-500','border-green-500','border-amber-500',
          'border-orange-500/50','border-blue-500/50','border-purple-500/50','border-pink-500/50','border-green-500/50','border-amber-500/50',
          'border-orange-500/20','border-blue-500/20','border-purple-500/20','border-pink-500/20','border-green-500/20','border-amber-500/20',
          'border-orange-500/30','border-blue-500/30','border-purple-500/30','border-pink-500/30','border-green-500/30','border-amber-500/30',

          // text
          'text-orange-500','text-blue-500','text-purple-500','text-pink-500','text-green-500','text-amber-500',
          'text-orange-200','text-blue-200','text-purple-200','text-pink-200','text-green-200','text-amber-200'
        ]
      }
    };
  </script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Iconify (reliable icons via lucide set: lucide:trophy, lucide:calendar, etc.) -->
  <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>

  <!-- Firebase Compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #020617; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    select option { background-color: #1e293b !important; color: white !important; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }

    /* subtle desktop background polish */
    @media (min-width: 1024px) {
      body{
        background:
          radial-gradient(1200px 700px at 10% 0%, rgba(249,115,22,0.14), transparent 60%),
          radial-gradient(1200px 700px at 90% 20%, rgba(236,72,153,0.12), transparent 60%),
          radial-gradient(900px 600px at 50% 100%, rgba(99,102,241,0.10), transparent 60%),
          #020617;
      }
    }
  </style>
</head>

<body class="text-slate-100 font-bold">
  <div id="root">
    <div class="min-h-screen flex flex-col items-center justify-center space-y-4 text-center p-6">
      <div class="w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
      <p class="text-orange-500 font-black uppercase tracking-widest text-xs tracking-[0.2em]">Syncing Mastery...</p>
    </div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // --- FIREBASE CONFIG (yours) ---
    const MANUAL_CONFIG = {
      apiKey: "AIzaSyD631oq7NL_6eX_d0_MM2TR0ebVNoo-844",
      authDomain: "my75mastery.firebaseapp.com",
      projectId: "my75mastery",
      storageBucket: "my75mastery.firebasestorage.app",
      messagingSenderId: "610595506034",
      appId: "1:610595506034:web:5d5ef97931285065537feb"
    };

    if (!firebase.apps.length) firebase.initializeApp(MANUAL_CONFIG);

    const auth = firebase.auth();
    const db = firebase.firestore();
    const appId = '75-day-mastery-v5';

    // --- DATE HELPERS (local-safe) ---
    const parseLocalDate = (yyyy_mm_dd) => {
      if (!yyyy_mm_dd) return null;
      const [y,m,d] = yyyy_mm_dd.split('-').map(n => parseInt(n, 10));
      if (!y || !m || !d) return null;
      return new Date(y, m-1, d, 12, 0, 0, 0); // midday avoids DST flips
    };
    const startOfLocalDay = (dt) => new Date(dt.getFullYear(), dt.getMonth(), dt.getDate(), 0,0,0,0);
    const diffDaysLocal = (startYYYYMMDD, endDateObj = new Date()) => {
      const s = parseLocalDate(startYYYYMMDD);
      if (!s) return 0;
      const start = startOfLocalDay(s);
      const end = startOfLocalDay(endDateObj);
      return Math.floor((end.getTime() - start.getTime()) / (1000*60*60*24));
    };

    // --- UI HELPERS ---
    // Icon component using Iconify (lucide icon set). No DOM replacement. No focus loss.
    const Icon = ({ name, className = "w-5 h-5" }) => {
      const n = (name || "").trim();
      if (!n) return (
        <span
          aria-hidden="true"
          className={className}
          style={{ display: "inline-block", borderRadius: "9999px", border: "2px solid currentColor", opacity: 0.25 }}
        />
      );

      // lucide icon set on Iconify: lucide:trophy, lucide:calendar, lucide:party-popper, etc.
      const iconName = `lucide:${n}`;

      return (
        <iconify-icon
          icon={iconName}
          className={className}
          aria-hidden="true"
        ></iconify-icon>
      );
    };

    const WeightChart = ({ data }) => {
      if (!data || data.length < 2) {
        return (
          <div className="h-32 flex items-center justify-center text-slate-600 text-xs italic border border-slate-800 rounded-2xl bg-slate-900/50">
            Log weight on multiple days to see progress trend...
          </div>
        );
      }
      const weights = data.map(d => d.weight);
      const minW = Math.min(...weights) - 2;
      const maxW = Math.max(...weights) + 2;
      const range = (maxW - minW) || 1;
      const width = 300;
      const height = 100;
      const points = data.map((d, i) => {
        const x = (i / (data.length - 1)) * width;
        const y = height - ((d.weight - minW) / range) * height;
        return `${x},${y}`;
      }).join(' ');
      return (
        <div className="mt-4 p-4 bg-slate-950 rounded-2xl border border-slate-800">
          <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-32 overflow-visible">
            <polyline fill="none" stroke="url(#gradient)" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" points={points} style={{ filter: 'drop-shadow(0 0 8px rgba(249,115,22,0.25))' }} />
            <defs>
              <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stopColor="#f97316" />
                <stop offset="100%" stopColor="#ec4899" />
              </linearGradient>
            </defs>
            {data.map((d, i) => (
              <circle key={i} cx={(i / (data.length - 1)) * width} cy={height - ((d.weight - minW) / range) * height} r="3" className="fill-white" />
            ))}
          </svg>
        </div>
      );
    };

    // Confetti (no pop-up)
    const Confetti = ({ run, onDone }) => {
      const canvasRef = useRef(null);
      const rafRef = useRef(null);
      const particlesRef = useRef([]);

      useEffect(() => {
        if (!run) return;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d', { alpha: true });

        const resize = () => {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        };
        resize();
        window.addEventListener('resize', resize);

        const colors = ['#f97316', '#ec4899', '#6366f1', '#22c55e', '#06b6d4', '#eab308', '#ffffff'];
        const makeParticle = () => {
          const w = canvas.width;
          const size = 6 + Math.random() * 8;
          const x = Math.random() * w;
          const y = -20 - Math.random() * 200;
          const vx = -2 + Math.random() * 4;
          const vy = 3 + Math.random() * 6;
          const rot = Math.random() * Math.PI;
          const vr = -0.15 + Math.random() * 0.3;
          const life = 120 + Math.floor(Math.random() * 60);
          return { x,y,vx,vy,size,rot,vr,life, color: colors[Math.floor(Math.random()*colors.length)] };
        };

        particlesRef.current = Array.from({ length: 140 }).map(makeParticle);

        let frame = 0;
        const tick = () => {
          frame++;
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          const grav = 0.05;
          particlesRef.current.forEach(p => {
            p.vy += grav;
            p.x += p.vx;
            p.y += p.vy;
            p.rot += p.vr;
            p.life -= 1;

            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot);
            ctx.fillStyle = p.color;
            ctx.globalAlpha = Math.max(0, Math.min(1, p.life / 60));
            ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size * 0.6);
            ctx.restore();
          });

          particlesRef.current = particlesRef.current.filter(p => p.life > 0 && p.y < canvas.height + 40);

          if (frame < 180 && particlesRef.current.length < 220) {
            for (let i = 0; i < 3; i++) particlesRef.current.push(makeParticle());
          }

          if (frame > 220 || particlesRef.current.length === 0) {
            cancelAnimationFrame(rafRef.current);
            window.removeEventListener('resize', resize);
            onDone && onDone();
            return;
          }

          rafRef.current = requestAnimationFrame(tick);
        };

        rafRef.current = requestAnimationFrame(tick);

        return () => {
          cancelAnimationFrame(rafRef.current);
          window.removeEventListener('resize', resize);
        };
      }, [run]);

      if (!run) return null;

      return (
        <div className="fixed inset-0 z-[9999] pointer-events-none">
          <canvas ref={canvasRef} className="w-full h-full" />
        </div>
      );
    };

    function App() {
      const fileInputRef = useRef(null);
      const lockTimerRef = useRef(null);

      // --- STATE ---
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [activeTab, setActiveTab] = useState('today');
      const [currentDayIndex, setCurrentDayIndex] = useState(0);
      const [daysData, setDaysData] = useState({});
      const [isUploading, setIsUploading] = useState(false);
      const [dbError, setDbError] = useState(null);
      const [showResetConfirm, setShowResetConfirm] = useState(false);

      const [appPhase, setAppPhase] = useState('auth');
      const [activeProfileId, setActiveProfileId] = useState(null);
      const [usernameInput, setUsernameInput] = useState('');
      const [passwordInput, setPasswordInput] = useState('');
      const [authStatus, setAuthStatus] = useState({ message: '', type: '' });

      const [lockToast, setLockToast] = useState('');

      // celebration
      const [celebrate, setCelebrate] = useState(false);
      const [celebrateBanner, setCelebrateBanner] = useState(false);
      const prevCompleteRef = useRef(false);

      // custom water
      const [customWaterOpen, setCustomWaterOpen] = useState(false);
      const [customWaterVal, setCustomWaterVal] = useState('');

      const [profile, setProfile] = useState({
        programType: 'hard_classic',
        startDate: new Date().toISOString().split('T')[0],
        dietDescription: '',
        intentions: '',
        isConfigured: false,
        targetWaterOz: 128,
        workoutCount: 2,
        workoutMins: 45,
        outdoorRequired: true,
        consumptionType: 'reading',
        consumptionGoal: 10,
        photoRequired: true,
        photoTitle: 'Progress Photo',
        alcoholRequired: true,
        alcoholLimit: 0,
        startWeight: '',
        currentWeight: '',
        measurements: { neck: '', chest: '', waist: '', arms: '', thighs: '', calves: '' }
      });

      const [draftProfile, setDraftProfile] = useState(null);

      // local day draft (fixes typing focus issues)
      const [dayDraft, setDayDraft] = useState({
        tasks: {},
        waterOz: 0,
        workout1_hrs: '',
        workout1_mins: '',
        workout1_desc: '',
        workout2_hrs: '',
        workout2_mins: '',
        workout2_desc: '',
        consumptionTitle: '',
        photoData: null,
        weight: ''
      });

      const normalizeUsername = (s) =>
        s.trim().toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');

      const showLocked = (msg) => {
        const text = msg || "Classic 75 Hard rules are locked. Switch to Custom 75 if you want to edit these settings.";
        setLockToast(text);
        if (lockTimerRef.current) clearTimeout(lockTimerRef.current);
        lockTimerRef.current = setTimeout(() => setLockToast(''), 2600);
      };

      // --- DATE & CALC HELPERS ---
      const getDisplayDate = (startStr, dayIdx) => {
        const s = parseLocalDate(startStr);
        if (!s) return "...";
        const d = new Date(s.getTime());
        d.setDate(d.getDate() + dayIdx);
        return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      };

      const checkDayComplete = (dayInfo, prof) => {
        if (!dayInfo || !prof) return false;
        const t = dayInfo.tasks || {};
        const waterMet = (dayInfo.waterOz || 0) >= (prof.targetWaterOz || 128);
        const w1 = t.workout1 === true;
        const w2 = prof.workoutCount === 2 ? t.workout2 === true : true;
        const diet = t.diet === true;
        const reading = t.consumption === true;
        const photo = prof.photoRequired ? t.photo === true : true;
        const alcohol = prof.alcoholRequired ? t.alcohol === true : true;
        return waterMet && w1 && w2 && diet && reading && photo && alcohol;
      };

      // --- COMPUTED VIEW DATA ---
      const currentDayKey = `day-${currentDayIndex + 1}`;
      const dayRaw = daysData[currentDayKey] || {};

      // keep dayDraft in sync when switching days / snapshots update
      useEffect(() => {
        setDayDraft({
          tasks: dayRaw.tasks || {},
          waterOz: dayRaw.waterOz || 0,
          workout1_hrs: dayRaw.workout1_hrs || '',
          workout1_mins: dayRaw.workout1_mins || '',
          workout1_desc: dayRaw.workout1_desc || '',
          workout2_hrs: dayRaw.workout2_hrs || '',
          workout2_mins: dayRaw.workout2_mins || '',
          workout2_desc: dayRaw.workout2_desc || '',
          consumptionTitle: dayRaw.consumptionTitle || '',
          photoData: dayRaw.photoData || null,
          weight: dayRaw.weight || ''
        });
      }, [currentDayIndex, dayRaw?.day, dayRaw?.owner, dayRaw?.updatedAt, JSON.stringify(dayRaw || {})]);

      const totalsData = useMemo(() => {
        let totalMins = 0; let completedCount = 0; let totalWater = 0; let totalEduValue = 0;
        const eduList = []; let firstPhoto = null; let latestPhoto = null;

        const sortedDays = Object.entries(daysData)
          .map(([id, d]) => ({ id, ...d }))
          .sort((a, b) => (a.day || 0) - (b.day || 0));

        sortedDays.forEach(day => {
          const mins =
            (parseInt(day.workout1_mins || 0) + (parseInt(day.workout1_hrs || 0) * 60)) +
            (parseInt(day.workout2_mins || 0) + (parseInt(day.workout2_hrs || 0) * 60));
          totalMins += mins;
          totalWater += (parseInt(day.waterOz) || 0);
          if (day.tasks?.consumption) totalEduValue += (parseInt(profile.consumptionGoal) || 10);
          if (day.consumptionTitle?.trim() && !eduList.includes(day.consumptionTitle.trim())) eduList.push(day.consumptionTitle.trim());
          if (day.photoData) { if (!firstPhoto) firstPhoto = day.photoData; latestPhoto = day.photoData; }
          if (checkDayComplete(day, profile)) completedCount++;
        });

        return {
          hours: Math.floor(totalMins / 60),
          mins: totalMins % 60,
          completedDays: completedCount,
          weightLost: (profile.startWeight && profile.currentWeight)
            ? (parseFloat(profile.startWeight) - parseFloat(profile.currentWeight)).toFixed(1)
            : '0.0',
          totalWater,
          totalEduValue,
          eduList,
          firstPhoto,
          latestPhoto
        };
      }, [daysData, profile]);

      const progressPct = Math.round((totalsData.completedDays / 75) * 100);

      const weightTrendData = useMemo(() => {
        return Object.entries(daysData)
          .map(([id, d]) => ({ day: d.day, weight: parseFloat(d.weight) }))
          .filter(d => !isNaN(d.weight))
          .sort((a, b) => a.day - b.day);
      }, [daysData]);

      // celebration trigger when day becomes complete
      const completeNow = useMemo(() => checkDayComplete({ ...dayDraft, day: currentDayIndex + 1 }, profile), [dayDraft, profile, currentDayIndex]);
      useEffect(() => {
        const prev = prevCompleteRef.current;
        if (!prev && completeNow) {
          setCelebrate(true);
          setCelebrateBanner(true);
          setTimeout(() => setCelebrateBanner(false), 2600);
        }
        prevCompleteRef.current = completeNow;
      }, [completeNow]);

      // --- CLOUD HELPERS ---
      const updateProfileOnCloud = async (updates) => {
        if (!activeProfileId) return;
        await db
          .collection('artifacts').doc(appId)
          .collection('public').doc('data')
          .collection('profiles').doc(activeProfileId)
          .set(updates, { merge: true });
      };

      const upsertLocalDay = (dayIdx, patch) => {
        const dayId = `day-${dayIdx + 1}`;
        setDaysData(prev => {
          const existing = prev[dayId] || {};
          return { ...prev, [dayId]: { ...existing, ...patch, day: dayIdx + 1 } };
        });
      };

      const updateDayData = async (dayIdx, updates) => {
        if (!activeProfileId) return;
        const dayId = `day-${dayIdx + 1}`;
        const existing = daysData[dayId] || {};
        const merged = { ...existing, ...updates, owner: activeProfileId, day: dayIdx + 1 };

        upsertLocalDay(dayIdx, merged);

        await db
          .collection('artifacts').doc(appId)
          .collection('public').doc('data')
          .collection('days')
          .doc(`${activeProfileId}_${dayId}`)
          .set(merged, { merge: true });
      };

      const commitProfileChanges = async () => {
        const target = draftProfile || profile;
        if (!target.dietDescription.trim() || !target.intentions.trim()) {
          setAuthStatus({ message: "Diet Goal and Intentions are required.", type: "error" });
          return;
        }
        const savePayload = { ...target, isConfigured: true };
        setProfile(savePayload);
        await updateProfileOnCloud(savePayload);
        setAppPhase('dashboard');
        setActiveTab('today');
        setAuthStatus({ message: '', type: '' });
      };

      const handleProfileAuth = async () => {
        const uInput = normalizeUsername(usernameInput);
        const pInput = passwordInput.trim();
        if (!uInput || !pInput) return setAuthStatus({ message: "Username and Password required.", type: "error" });

        try {
          const profileRef =
            db.collection('artifacts').doc(appId)
              .collection('public').doc('data')
              .collection('profiles').doc(uInput);

          const docSnap = await profileRef.get();

          if (docSnap.exists) {
            if (docSnap.data().passcode === pInput) {
              await db
                .collection('artifacts').doc(appId)
                .collection('users').doc(user.uid)
                .collection('profile').doc('session_link')
                .set({ activeProfileId: uInput });
              setActiveProfileId(uInput);
            } else {
              setAuthStatus({ message: "Incorrect password.", type: "error" });
            }
          } else {
            const newP = { ...profile, passcode: pInput, isConfigured: false, startDate: new Date().toISOString().split('T')[0] };
            await profileRef.set(newP);
            await db
              .collection('artifacts').doc(appId)
              .collection('users').doc(user.uid)
              .collection('profile').doc('session_link')
              .set({ activeProfileId: uInput });
            setAppPhase('setup');
            setDraftProfile(newP);
            setActiveProfileId(uInput);
          }
        } catch (e) {
          console.error(e);
          setAuthStatus({ message: e?.message || "Connection failed.", type: "error" });
        }
      };

      const applyProgramPresetToDraft = (type) => {
        let updates = { programType: type };
        if (type === 'hard_classic') {
          updates = {
            ...updates,
            workoutCount: 2,
            workoutMins: 45,
            outdoorRequired: true,
            targetWaterOz: 128,
            consumptionType: 'reading',
            consumptionGoal: 10,
            dietRequired: true,
            photoRequired: true,
            alcoholRequired: true,
            alcoholLimit: 0
          };
        } else if (type === 'custom') {
          updates = {
            ...updates,
            workoutCount: 1,
            workoutMins: 45,
            outdoorRequired: false,
            targetWaterOz: 128,
            consumptionType: 'reading',
            consumptionGoal: 10,
            dietRequired: true,
            photoRequired: true,
            alcoholRequired: false,
            alcoholLimit: 0
          };
        }
        setDraftProfile(prev => ({ ...(prev || profile), ...updates }));
      };

      const updateProfileOnTheFly = async (updates) => {
        setProfile(prev => ({ ...prev, ...updates }));
        await updateProfileOnCloud(updates);
      };

      const handleFullReset = async () => {
        const confirmPhrase = prompt("Type 'RESTART' to wipe all progress. This cannot be undone.");
        if (confirmPhrase === 'RESTART') {
          setLoading(true);
          const resetProfile = { ...profile, isConfigured: false };
          setProfile(resetProfile);
          setDraftProfile(resetProfile);
          await updateProfileOnCloud(resetProfile);

          const daysCol =
            db.collection('artifacts').doc(appId)
              .collection('public').doc('data')
              .collection('days');

          const snapshot = await daysCol.get();
          const batch = db.batch();
          snapshot.forEach(doc => { if (doc.data().owner === activeProfileId) batch.delete(doc.ref); });
          await batch.commit();

          setDaysData({});
          setAppPhase('setup');
          setShowResetConfirm(false);
          setLoading(false);
        }
      };

      const handleSignOut = async () => {
        if (confirm("Logout?")) {
          await db
            .collection('artifacts').doc(appId)
            .collection('users').doc(user.uid)
            .collection('profile').doc('session_link')
            .set({ activeProfileId: null });

          setActiveProfileId(null);
          setAppPhase('auth');
          setDaysData({});
          window.location.reload();
        }
      };

      const handlePhotoUpload = async (e) => {
        const file = e.target.files?.[0];
        if (!file || !activeProfileId) return;
        setIsUploading(true);
        e.target.value = '';

        const reader = new FileReader();
        reader.onloadend = async () => {
          const nextTasks = { ...dayDraft.tasks, photo: true };
          setDayDraft(prev => ({ ...prev, photoData: reader.result, tasks: nextTasks }));
          await updateDayData(currentDayIndex, {
            photoData: reader.result,
            tasks: nextTasks
          });
          setIsUploading(false);
        };
        reader.readAsDataURL(file);
      };

      const removePhoto = async () => {
        if (!confirm("Remove photo?")) return;
        const nextTasks = { ...dayDraft.tasks, photo: false };
        setDayDraft(prev => ({ ...prev, photoData: null, tasks: nextTasks }));
        await updateDayData(currentDayIndex, {
          photoData: null,
          tasks: nextTasks
        });
      };

      // --- EFFECTS ---
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (u) => {
          if (!u) {
            try { await auth.signInAnonymously(); }
            catch (e) { setDbError("Auth failed: " + (e?.message || "")); setLoading(false); }
          } else {
            setUser(u);
            try {
              const linkRef =
                db.collection('artifacts').doc(appId)
                  .collection('users').doc(u.uid)
                  .collection('profile').doc('session_link');

              const linkSnap = await linkRef.get();
              if (linkSnap.exists && linkSnap.data().activeProfileId) {
                setActiveProfileId(linkSnap.data().activeProfileId);
              } else {
                setAppPhase('auth');
                setLoading(false);
              }
            } catch (e) {
              setDbError("Database connectivity error: " + (e?.message || ""));
              setLoading(false);
            }
          }
        });
        return () => unsubscribe();
      }, []);

      useEffect(() => {
        if (!user || !activeProfileId) return;

        const profileRef =
          db.collection('artifacts').doc(appId)
            .collection('public').doc('data')
            .collection('profiles').doc(activeProfileId);

        const unsub = profileRef.onSnapshot((docSnap) => {
          if (docSnap.exists) {
            const data = docSnap.data();
            setProfile(data);
            if (!draftProfile) setDraftProfile(data);
            setAppPhase(data.isConfigured ? 'dashboard' : 'setup');
          } else {
            setAppPhase('setup');
          }
          setLoading(false);
        }, (err) => {
          setDbError("Profile listener error: " + (err?.message || ""));
          setLoading(false);
        });

        return () => unsub();
      }, [user, activeProfileId]);

      useEffect(() => {
        if (!user || !activeProfileId) return;

        const daysCol =
          db.collection('artifacts').doc(appId)
            .collection('public').doc('data')
            .collection('days');

        const unsub = daysCol
          .where('owner', '==', activeProfileId)
          .onSnapshot((snap) => {
            const next = {};
            snap.forEach((doc) => {
              const data = doc.data();
              if (data?.day) next[`day-${data.day}`] = data;
            });
            setDaysData(next);
          }, (err) => {
            console.error("Days listener error:", err);
            setDbError("Days listener error: " + (err?.message || ""));
          });

        return () => unsub();
      }, [user, activeProfileId]);

      // default to today's day on open
      useEffect(() => {
        if (!activeProfileId) return;
        if (!profile?.startDate) return;
        const idx = diffDaysLocal(profile.startDate, new Date());
        setCurrentDayIndex(Math.max(0, Math.min(74, idx)));
      }, [activeProfileId, profile?.startDate]);

      // --- RENDER HELPERS ---
      const LockedOverlay = ({ isLocked }) => {
        if (!isLocked) return null;
        return (
          <div className="absolute inset-0 rounded-2xl cursor-not-allowed" onClick={() => showLocked()}>
            <div className="absolute inset-0 rounded-2xl bg-slate-950/10"></div>
          </div>
        );
      };

      // ✅ FIXED TIME INPUT: local while typing, commit on blur/Enter
      const LocalTimeInput = ({ syncKey, initialValue, placeholder, onCommit }) => {
        const [local, setLocal] = useState(initialValue ?? '');

        useEffect(() => {
          setLocal(initialValue ?? '');
        }, [syncKey, initialValue]);

        return (
          <input
            type="text"
            inputMode="numeric"
            pattern="[0-9]*"
            autoComplete="off"
            placeholder={placeholder}
            className="w-16 sm:w-18 bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 text-center font-bold text-white outline-none focus:border-orange-500 placeholder:text-slate-600"
            value={local}
            onChange={(e) => {
              const digitsOnly = (e.target.value || '').replace(/\D/g,'').slice(0, 3);
              setLocal(digitsOnly);
            }}
            onKeyDown={(e) => {
              if (e.key === 'Enter') e.currentTarget.blur();
            }}
            onBlur={() => onCommit && onCommit(local)}
          />
        );
      };

      const renderSetupUI = (isTab = false) => {
        const target = draftProfile || profile;
        const isHardPreset = target.programType === 'hard_classic';

        return (
          <div className={isTab ? "space-y-6" : "min-h-screen bg-slate-950 flex flex-col items-center justify-center p-6 text-center"}>
            <div className={isTab ? "bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] shadow-2xl space-y-6" : "max-w-lg w-full bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] shadow-2xl space-y-6 max-h-[90vh] overflow-y-auto scrollbar-hide"}>

              {!isTab && <div className="mx-auto text-indigo-400"><Icon name="target" className="w-12 h-12" /></div>}

              <h2 className="text-2xl font-black uppercase text-white">Program Configuration</h2>

              {isHardPreset && (
                <div className="p-4 rounded-2xl bg-orange-500/10 border border-orange-500/20 text-left">
                  <p className="text-[10px] font-black uppercase text-orange-400 tracking-widest">Classic rules are locked</p>
                  <p className="text-xs text-slate-300 mt-1 leading-relaxed">
                    You picked <span className="text-white font-black">75 Hard (Classic)</span>, so the official requirements are fixed.
                    Switch to <span className="text-white font-black">Custom 75</span> if you want to edit goals.
                  </p>
                </div>
              )}

              <div className="space-y-6 text-left">
                <div className="p-4 bg-slate-800/20 rounded-2xl border border-slate-800 relative">
                  <label className="text-[10px] font-black uppercase text-slate-500 block mb-1">Mode</label>
                  <select
                    className="w-full bg-slate-800 p-3 rounded-xl text-white font-bold outline-none border border-slate-700"
                    value={target.programType}
                    onChange={(e) => applyProgramPresetToDraft(e.target.value)}
                  >
                    <option value="hard_classic">75 Hard (Classic Rules)</option>
                    <option value="custom">Custom 75</option>
                  </select>
                </div>

                <div className="p-4 bg-slate-800/10 rounded-2xl border border-slate-800/50 space-y-4 relative">
                  <label className="text-[10px] font-black text-cyan-500 uppercase flex items-center gap-2">
                    <Icon name="droplets" /> Hydration Goal
                  </label>
                  <div>
                    <label className="block text-[10px] text-slate-500 uppercase mb-2">Daily Water Target (Oz)</label>
                    <input
                      disabled={isHardPreset}
                      type="number"
                      className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white font-bold disabled:opacity-50"
                      value={target.targetWaterOz}
                      onChange={(e) => setDraftProfile({ ...target, targetWaterOz: parseInt(e.target.value) || 0 })}
                    />
                  </div>
                  <LockedOverlay isLocked={isHardPreset} />
                </div>

                <div className="p-4 bg-slate-800/10 rounded-2xl border border-slate-800/50 space-y-4 relative">
                  <label className="text-[10px] font-black text-orange-500 uppercase flex items-center gap-2">
                    <Icon name="dumbbell" /> Workouts
                  </label>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="text-[10px] text-slate-500 uppercase block mb-1">Count</label>
                      <select
                        disabled={isHardPreset}
                        className="w-full bg-slate-800 p-2 rounded-xl text-white font-bold disabled:opacity-50"
                        value={target.workoutCount}
                        onChange={(e) => setDraftProfile({ ...target, workoutCount: parseInt(e.target.value) })}
                      >
                        <option value={1}>1</option>
                        <option value={2}>2</option>
                      </select>
                    </div>
                    <div>
                      <label className="text-[10px] text-slate-500 uppercase block mb-1">Min each</label>
                      <input
                        type="number"
                        disabled={isHardPreset}
                        className="w-full bg-slate-800 p-2 rounded-xl text-white font-bold disabled:opacity-50"
                        value={target.workoutMins}
                        onChange={(e) => setDraftProfile({ ...target, workoutMins: parseInt(e.target.value) || 0 })}
                      />
                    </div>
                  </div>

                  <div className="flex items-center justify-between">
                    <span className="text-xs text-slate-300">Outdoor Required</span>
                    <button
                      disabled={isHardPreset}
                      onClick={() => setDraftProfile({ ...target, outdoorRequired: !target.outdoorRequired })}
                      className={`w-10 h-5 rounded-full relative ${target.outdoorRequired ? 'bg-orange-500' : 'bg-slate-700'}`}
                    >
                      <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${target.outdoorRequired ? 'right-1' : 'left-1'}`} />
                    </button>
                  </div>

                  <LockedOverlay isLocked={isHardPreset} />
                </div>

                <div className="p-4 bg-slate-800/10 rounded-2xl border border-slate-800/50 space-y-4 relative">
                  <label className="text-[10px] font-black text-purple-500 uppercase flex items-center gap-2">
                    <Icon name="book-open" /> Learning
                  </label>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="text-[10px] text-slate-500">Type</label>
                      <select
                        disabled={isHardPreset}
                        className="w-full bg-slate-800 p-2 rounded-xl text-white font-bold disabled:opacity-50"
                        value={target.consumptionType}
                        onChange={(e) => setDraftProfile({ ...target, consumptionType: e.target.value })}
                      >
                        <option value="reading">Book</option>
                        <option value="podcast">Podcast</option>
                      </select>
                    </div>
                    <div>
                      <label className="text-[10px] text-slate-500">
                        Goal ({target.consumptionType === 'reading' ? 'Pages' : 'Mins'})
                      </label>
                      <input
                        type="number"
                        disabled={isHardPreset}
                        className="w-full bg-slate-800 p-2 rounded-xl text-white font-bold disabled:opacity-50"
                        value={target.consumptionGoal}
                        onChange={(e) => setDraftProfile({ ...target, consumptionGoal: parseInt(e.target.value) || 0 })}
                      />
                    </div>
                  </div>

                  <LockedOverlay isLocked={isHardPreset} />
                </div>

                <div className="p-4 bg-slate-800/10 rounded-2xl border border-slate-800/50 space-y-4 relative">
                  <label className="text-[10px] font-black text-amber-500 uppercase flex items-center gap-2">
                    <Icon name="beer" /> Alcohol
                  </label>
                  <div className="flex items-center justify-between">
                    <span className="text-xs text-slate-300">Strict Zero Alcohol</span>
                    <button
                      disabled={isHardPreset}
                      onClick={() => setDraftProfile({ ...target, alcoholRequired: !target.alcoholRequired })}
                      className={`w-10 h-5 rounded-full relative ${target.alcoholRequired ? 'bg-amber-500' : 'bg-slate-700'}`}
                    >
                      <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${target.alcoholRequired ? 'right-1' : 'left-1'}`} />
                    </button>
                  </div>

                  {!target.alcoholRequired && (
                    <div>
                      <label className="block text-[10px] text-slate-500 uppercase mb-2">Daily Limit</label>
                      <input
                        type="number"
                        disabled={isHardPreset}
                        className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white font-bold disabled:opacity-50"
                        placeholder="Max drinks per day..."
                        value={target.alcoholLimit}
                        onChange={(e) => setDraftProfile({ ...target, alcoholLimit: parseInt(e.target.value) || 0 })}
                      />
                    </div>
                  )}

                  <LockedOverlay isLocked={isHardPreset} />
                </div>

                <div className="p-4 bg-slate-800/10 rounded-2xl border border-slate-800/50 space-y-4 relative">
                  <label className="text-[10px] font-black text-pink-500 uppercase flex items-center gap-2">
                    <Icon name="camera" /> Progress Photo
                  </label>

                  <div className="flex items-center justify-between">
                    <span className="text-xs text-slate-300">Require Daily Photo</span>
                    <button
                      disabled={isHardPreset}
                      onClick={() => setDraftProfile({ ...target, photoRequired: !target.photoRequired })}
                      className={`w-10 h-5 rounded-full relative ${target.photoRequired ? 'bg-pink-500' : 'bg-slate-700'}`}
                    >
                      <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${target.photoRequired ? 'right-1' : 'left-1'}`} />
                    </button>
                  </div>

                  <LockedOverlay isLocked={isHardPreset} />
                </div>

                <div className="p-4 bg-slate-800/10 rounded-2xl border border-slate-800/50 space-y-4 relative">
                  <div>
                    <label className="text-[10px] text-slate-500 uppercase block mb-1">Start Date</label>
                    <input
                      type="date"
                      className="w-full bg-slate-800 p-3 rounded-xl text-white font-bold border border-slate-700"
                      value={target.startDate}
                      onChange={(e) => setDraftProfile({ ...target, startDate: e.target.value })}
                    />
                    <p className="mt-2 text-[10px] text-slate-500 uppercase font-black">Start date is always editable.</p>
                  </div>
                </div>

                <div className="p-4 bg-slate-800/10 rounded-2xl border border-slate-800/50 space-y-4">
                  <div>
                    <label className="text-[10px] text-slate-500 uppercase block mb-1">Diet Protocol</label>
                    <input
                      type="text"
                      className="w-full bg-slate-800 p-3 rounded-xl text-white font-bold border border-slate-700"
                      placeholder="e.g. IF, No Sugar"
                      value={target.dietDescription}
                      onChange={(e) => setDraftProfile({ ...target, dietDescription: e.target.value })}
                    />
                  </div>

                  <div>
                    <label className="text-[10px] text-slate-500 uppercase block mb-1">The Big “Why”</label>
                    <textarea
                      className="w-full bg-slate-800 p-3 rounded-xl text-white font-bold h-20 border border-slate-700"
                      placeholder="Your motivation..."
                      value={target.intentions}
                      onChange={(e) => setDraftProfile({ ...target, intentions: e.target.value })}
                    />
                  </div>
                </div>

                <button
                  onClick={commitProfileChanges}
                  className="w-full bg-green-600 p-5 rounded-2xl text-white font-black uppercase text-sm shadow-xl hover:bg-green-500 transition-all"
                >
                  {isTab ? "Save Changes & Return" : "Launch Journey"}
                </button>

                {isTab && (
                  <div className="pt-6 border-t border-slate-800">
                    {showResetConfirm ? (
                      <div className="bg-rose-500/10 border border-rose-500/30 p-4 rounded-3xl space-y-4">
                        <p className="text-xs text-rose-500 uppercase font-black text-center">Permanent Reset Warning</p>
                        <div className="flex gap-2">
                          <button onClick={handleFullReset} className="flex-1 bg-rose-500 p-4 rounded-xl text-xs text-white font-black uppercase">Confirm Wipe</button>
                          <button onClick={() => setShowResetConfirm(false)} className="px-6 bg-slate-800 p-4 rounded-xl text-xs text-slate-400 font-black uppercase">Cancel</button>
                        </div>
                      </div>
                    ) : (
                      <button
                        onClick={() => setShowResetConfirm(true)}
                        className="w-full p-4 rounded-2xl text-rose-500 font-black uppercase text-[10px] border border-rose-500/30"
                      >
                        Reset Entire Journey
                      </button>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };

      // --- AUTH/UI ---
      if (loading) {
        return (
          <div className="flex flex-col items-center justify-center h-screen bg-slate-950 text-orange-500 uppercase font-black tracking-widest gap-4">
            <div className="w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
            Establishing Hub...
          </div>
        );
      }

      const LockToast = () => (
        lockToast ? (
          <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[999] px-4">
            <div className="max-w-md bg-slate-900 border border-orange-500/30 shadow-2xl rounded-2xl px-4 py-3 text-xs text-slate-200">
              <div className="flex items-start gap-2">
                <div className="mt-0.5 text-orange-400"><Icon name="lock" /></div>
                <div>
                  <div className="text-[10px] uppercase font-black text-orange-400 tracking-widest">Locked</div>
                  <div className="mt-1 leading-relaxed">{lockToast}</div>
                </div>
              </div>
            </div>
          </div>
        ) : null
      );

      const CelebrateBanner = () => (
        celebrateBanner ? (
          <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[9998] px-4">
            <div className="max-w-xl bg-slate-900 border border-green-500/30 shadow-2xl rounded-2xl px-5 py-4 text-sm text-slate-100">
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-xl bg-green-500 text-white shadow-lg">
                  <Icon name="party-popper" className="w-5 h-5" />
                </div>
                <div>
                  <div className="text-[10px] uppercase font-black text-green-400 tracking-widest">
                    Day {currentDayIndex + 1} Complete
                  </div>
                  <div className="mt-1 font-black">Nice. Everything checked off.</div>
                </div>
              </div>
            </div>
          </div>
        ) : null
      );

      if (appPhase === 'auth') {
        return (
          <div className="min-h-screen bg-slate-950 flex items-center justify-center p-6">
            <LockToast />
            <div className="max-w-md w-full space-y-8 animate-in fade-in duration-500">
              <div className="text-center space-y-2">
                <div className="inline-block p-4 bg-orange-500 rounded-3xl text-white shadow-2xl mb-4">
                  <Icon name="trophy" className="w-10 h-10" />
                </div>
                <h1 className="text-4xl font-black uppercase text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-rose-600 tracking-tighter leading-none">
                  75 Mastery
                </h1>
                <p className="text-xs text-slate-400 max-w-sm mx-auto leading-relaxed">
                  Private profiles (no email). Use a username + passcode to access your progress from any device.
                </p>
              </div>

              <div className="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-2xl space-y-6 text-center">
                <div className="space-y-4">
                  <div className="relative text-left">
                    <label className="text-[10px] font-black text-slate-500 uppercase ml-2 mb-1 block tracking-widest">Username</label>
                    <div className="absolute left-4 top-[34px] w-5 h-5 text-slate-600"><Icon name="user" /></div>
                    <input
                      type="text"
                      className="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 pl-12 text-white outline-none focus:border-indigo-500"
                      placeholder="Username"
                      value={usernameInput}
                      onChange={(e) => setUsernameInput(e.target.value)}
                    />
                  </div>

                  <div className="relative text-left">
                    <label className="text-[10px] font-black text-slate-500 uppercase ml-2 mb-1 block tracking-widest">Passcode</label>
                    <div className="absolute left-4 top-[34px] w-5 h-5 text-slate-600"><Icon name="lock" /></div>
                    <input
                      type="password"
                      className="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 pl-12 text-white outline-none focus:border-indigo-500"
                      placeholder="Passcode"
                      value={passwordInput}
                      onChange={(e) => setPasswordInput(e.target.value)}
                    />
                  </div>
                </div>

                {authStatus.message && (
                  <div className={`p-3 rounded-xl text-[10px] font-black uppercase text-center ${
                    authStatus.type === 'error'
                      ? 'bg-rose-500/10 text-rose-500'
                      : 'bg-green-500/10 text-green-500'
                  }`}>
                    {authStatus.message}
                  </div>
                )}

                {dbError && (
                  <div className="p-3 rounded-xl text-[10px] font-black uppercase text-center bg-rose-500/10 text-rose-300 border border-rose-500/20">
                    {dbError}
                  </div>
                )}

                <button
                  onClick={handleProfileAuth}
                  className="w-full bg-indigo-500 p-5 rounded-2xl text-white font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all text-sm"
                >
                  Login or Create Profile
                </button>

                <p className="text-[10px] text-slate-500 leading-relaxed">
                  Tip: use the same username + passcode on phone + desktop.
                </p>
              </div>
            </div>
          </div>
        );
      }

      if (appPhase === 'setup') return (
        <>
          <LockToast />
          {renderSetupUI(false)}
        </>
      );

      // --- DASHBOARD CALCS ---
      const isWaterDoneNow = (dayDraft.waterOz || 0) >= (profile.targetWaterOz || 128);
      const w1MinsNow = (parseInt(dayDraft.workout1_hrs) || 0) * 60 + (parseInt(dayDraft.workout1_mins) || 0);
      const w2MinsNow = (parseInt(dayDraft.workout2_hrs) || 0) * 60 + (parseInt(dayDraft.workout2_mins) || 0);

      const pillarsNow = [
        { id: 'workout1', label: profile.outdoorRequired ? 'Outdoor Workout' : 'Workout One', icon: 'dumbbell', sub: `${profile.workoutMins} Min Req`, qualifies: w1MinsNow >= profile.workoutMins, theme: 'orange' },
        ...(profile.workoutCount === 2 ? [{ id: 'workout2', label: 'Workout Two', icon: 'dumbbell', sub: `${profile.workoutMins} Min Req`, qualifies: w2MinsNow >= profile.workoutMins, theme: 'blue' }] : []),
        { id: 'consumption', label: profile.programType === 'hard_classic' ? 'Reading Log' : (profile.consumptionType === 'reading' ? 'Reading Log' : 'Podcast Log'), icon: profile.consumptionType === 'reading' ? 'book-open' : 'mic', sub: `Goal: ${profile.consumptionGoal} ${profile.consumptionType === 'reading' ? 'Pages' : 'Mins'}`, theme: 'purple' },
        ...(profile.photoRequired ? [{ id: 'photo', label: profile.photoTitle || 'Visual Progress', icon: 'camera', sub: 'Daily Selfie', theme: 'pink' }] : []),
        { id: 'diet', label: 'Follow a Diet', icon: 'utensils', sub: profile.programType === 'hard_classic' ? `${profile.dietDescription || 'Standard'} • No Cheats` : (profile.dietDescription || 'No Cheats'), theme: 'green' },
        ...(profile.alcoholRequired || profile.alcoholLimit > 0 ? [{ id: 'alcohol', label: profile.alcoholRequired ? 'No Alcohol' : 'Alcohol Limit', icon: 'beer', sub: profile.alcoholRequired ? 'Zero Tolerance' : `Max ${profile.alcoholLimit} drinks / day`, theme: 'amber' }] : [])
      ];

      const colorMap = {
        orange: 'from-orange-500/20 to-orange-500/5',
        blue: 'from-blue-500/20 to-blue-500/5',
        purple: 'from-purple-500/20 to-purple-500/5',
        pink: 'from-pink-500/20 to-pink-500/5',
        green: 'from-green-500/20 to-green-500/5',
        amber: 'from-amber-500/20 to-amber-500/5'
      };

      // Desktop nav (website-style), mobile keeps the app tabs
      const DesktopTopNav = () => (
        <div className="hidden lg:block sticky top-0 z-40">
          <div className="bg-slate-950/60 backdrop-blur border-b border-slate-800">
            <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between gap-6">
              <div className="flex items-center gap-3">
                <div className="p-3 rounded-2xl bg-orange-500 text-white shadow-xl">
                  <Icon name="trophy" className="w-6 h-6" />
                </div>
                <div>
                  <div className="text-xl font-black uppercase text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-rose-600">
                    75 Mastery
                  </div>
                  <div className="text-[10px] uppercase text-slate-500 font-black tracking-widest">
                    {activeProfileId} • Day {currentDayIndex + 1} • {progressPct}% complete
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-2">
                {['today','gallery','stats','tips','setup'].map(t => (
                  <button
                    key={t}
                    onClick={() => setActiveTab(t)}
                    className={`px-4 py-2 rounded-xl text-xs font-black uppercase border transition-all ${
                      activeTab === t
                        ? 'bg-orange-500 text-white border-orange-400 shadow-lg'
                        : 'bg-slate-900/40 text-slate-300 border-slate-800 hover:bg-slate-900'
                    }`}
                  >
                    {t === 'setup' ? 'settings' : t}
                  </button>
                ))}
                <button
                  onClick={handleSignOut}
                  className="ml-2 px-4 py-2 rounded-xl text-xs font-black uppercase border border-slate-800 text-slate-300 hover:text-rose-300 hover:border-rose-500/30 hover:bg-rose-500/10 transition-all"
                >
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      );

      return (
        <div className="min-h-screen bg-slate-950 text-slate-100 font-sans pb-32 animate-in fade-in duration-500 font-bold">
          <Confetti run={celebrate} onDone={() => setCelebrate(false)} />
          <CelebrateBanner />
          <LockToast />

          <DesktopTopNav />

          {/* Mobile header */}
          <header className="p-6 bg-slate-900 border-b border-slate-800 sticky top-0 z-40 shadow-xl lg:hidden">
            <div className="flex justify-between items-start mb-6">
              <div>
                <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-rose-600 uppercase">
                  75 Mastery
                </h1>
                <p className="text-[10px] text-slate-500 font-bold uppercase mt-2">
                  Profile: {activeProfileId}
                </p>
              </div>

              <div className="text-right">
                <div className="text-xs font-black text-orange-400 uppercase">Day {currentDayIndex + 1}</div>
                <button
                  onClick={handleSignOut}
                  className="mt-2 text-[10px] uppercase font-black text-slate-400 hover:text-rose-400 transition-colors"
                >
                  Logout
                </button>
              </div>
            </div>

            <div className="relative h-3 bg-slate-800 rounded-full overflow-hidden mb-2">
              <div className="absolute h-full bg-gradient-to-r from-orange-500 to-rose-500 transition-all duration-1000" style={{ width: `${progressPct}%` }} />
            </div>

            <div className="flex justify-between text-[10px] font-black text-slate-500 uppercase">
              <span>{progressPct}% Complete</span>
              <span>{totalsData.completedDays} / 75 Days</span>
            </div>
          </header>

          {/* Mobile app-style nav */}
          <nav className="flex px-4 py-2 gap-2 bg-slate-950 sticky top-[138px] z-30 shadow-2xl border-b border-slate-900 overflow-x-auto scrollbar-hide lg:hidden">
            {['today', 'gallery', 'stats', 'tips', 'setup'].map(tab => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`flex-1 min-w-[90px] py-3 rounded-xl text-[10px] font-black uppercase transition-all flex flex-col items-center gap-1 ${
                  activeTab === tab ? 'bg-orange-500 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-900'
                }`}
              >
                <Icon name={tab === 'today' ? 'calendar' : tab === 'gallery' ? 'layout-grid' : tab === 'stats' ? 'activity' : tab === 'tips' ? 'lightbulb' : 'settings'} />
                {tab}
              </button>
            ))}
          </nav>

          <main className="p-4 max-w-lg mx-auto space-y-6 lg:max-w-6xl">
            {dbError && (
              <div className="p-3 rounded-xl bg-rose-500/10 border border-rose-500/30 text-rose-200 text-xs">
                {dbError}
              </div>
            )}

            {activeTab === 'today' && (
              <>
                <div className="p-5 bg-orange-500/5 border border-orange-500/20 rounded-3xl text-center shadow-lg">
                  <p className="text-[10px] font-black uppercase text-orange-500 mb-2">Remember Why You Started</p>
                  <p className="italic text-sm text-orange-200/70">"{profile.intentions}"</p>
                </div>

                <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-xl flex flex-col space-y-3">
                  <label className="text-[10px] font-black text-slate-500 uppercase">Jump to Day</label>
                  <div className="flex items-center justify-between gap-4">
                    <select
                      className="flex-1 bg-slate-800 border border-slate-700 rounded-xl p-3 text-white font-black outline-none"
                      value={currentDayIndex}
                      onChange={(e) => setCurrentDayIndex(parseInt(e.target.value))}
                    >
                      {Array.from({ length: 75 }).map((_, i) => (
                        <option key={i} value={i}>Day {i + 1}</option>
                      ))}
                    </select>
                    <p className="text-sm font-bold">{getDisplayDate(profile.startDate, currentDayIndex)}</p>
                  </div>
                </div>

                {/* Hydration */}
                <div className={`p-5 rounded-3xl border transition-all ${isWaterDoneNow ? 'bg-cyan-500/10 border-cyan-500/50 shadow-inner' : 'bg-slate-900 border-slate-800'}`}>
                  <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center gap-2">
                      <div className={`p-2 rounded-lg ${isWaterDoneNow ? "bg-cyan-500 text-white shadow-md" : "bg-cyan-500/20 text-cyan-400"}`}>
                        <Icon name={isWaterDoneNow ? "check" : "droplets"} />
                      </div>
                      <h3 className="font-black text-sm uppercase">Hydration</h3>
                      {isWaterDoneNow && <span className="bg-cyan-500 text-white text-[8px] font-black px-2 py-0.5 rounded-full">Goal Met</span>}
                    </div>

                    <div className="text-right flex items-center gap-2 font-black">
                      <input
                        type="number"
                        className="bg-slate-950 border border-slate-800 px-2 py-1 rounded w-16 text-center text-white font-bold outline-none focus:border-cyan-500"
                        value={dayDraft.waterOz || 0}
                        onChange={(e) => setDayDraft(prev => ({ ...prev, waterOz: parseInt(e.target.value) || 0 }))}
                        onBlur={() => updateDayData(currentDayIndex, { waterOz: parseInt(dayDraft.waterOz) || 0 })}
                      />
                      <span className="text-xs text-slate-500 font-black">Oz / {profile.targetWaterOz}</span>
                    </div>
                  </div>

                  <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide items-center">
                    {[8, 16, 24, 32].map(oz => (
                      <button
                        key={oz}
                        onClick={() => {
                          const next = (dayDraft.waterOz || 0) + oz;
                          setDayDraft(prev => ({ ...prev, waterOz: next }));
                          updateDayData(currentDayIndex, { waterOz: next });
                        }}
                        className="bg-slate-800 border border-slate-700 px-4 py-2 rounded-xl text-xs font-bold text-slate-300 hover:bg-slate-700"
                      >
                        +{oz}oz
                      </button>
                    ))}

                    <button
                      onClick={() => setCustomWaterOpen(v => !v)}
                      className="bg-slate-800 border border-slate-700 px-4 py-2 rounded-xl text-xs font-bold text-slate-300 hover:bg-slate-700"
                    >
                      Custom
                    </button>

                    {customWaterOpen && (
                      <div className="flex items-center gap-2 bg-slate-950/40 border border-slate-800 rounded-xl px-3 py-2">
                        <input
                          type="number"
                          inputMode="numeric"
                          placeholder="oz"
                          className="w-20 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-white font-black outline-none focus:border-cyan-500 placeholder:text-slate-600"
                          value={customWaterVal}
                          onChange={(e) => setCustomWaterVal(e.target.value)}
                        />
                        <button
                          onClick={() => {
                            const add = Number(customWaterVal || 0);
                            if (!add || add <= 0) return;
                            const next = Number(dayDraft.waterOz || 0) + add;
                            setDayDraft(prev => ({ ...prev, waterOz: next }));
                            updateDayData(currentDayIndex, { waterOz: next });
                            setCustomWaterVal('');
                            setCustomWaterOpen(false);
                          }}
                          className="px-3 py-2 rounded-lg bg-cyan-600 text-white font-black text-xs uppercase hover:bg-cyan-500"
                        >
                          Add
                        </button>
                      </div>
                    )}
                  </div>
                </div>

                {/* Pillars */}
                <div className="space-y-4">
                  {pillarsNow.map(p => {
                    const done = !!dayDraft.tasks?.[p.id];
                    const themeColor = p.theme || 'orange';
                    const qualifiesOk = p.id.startsWith('workout') ? !!p.qualifies : true;

                    return (
                      <div
                        key={p.id}
                        className={`p-5 rounded-3xl border transition-all ${
                          done
                            ? `bg-gradient-to-br ${colorMap[themeColor]} border-${themeColor}-500/50 shadow-inner`
                            : 'bg-slate-900 border-slate-800 shadow-xl'
                        }`}
                      >
                        <div className="flex justify-between items-start mb-4">
                          <div className="flex items-center gap-2">
                            <div className={`p-2 rounded-lg ${done ? `bg-${themeColor}-500 text-white shadow-md` : `bg-${themeColor}-500/20 text-${themeColor}-500`}`}>
                              <Icon name={p.icon} />
                            </div>
                            <div>
                              <h3 className={`font-black text-sm uppercase ${done ? 'text-white' : 'text-slate-300'}`}>{p.label}</h3>
                              <p className="text-[10px] text-slate-500 uppercase">{p.sub}</p>
                            </div>
                          </div>

                          {/* ✅ typing-safe time inputs */}
                          {p.id.startsWith('workout') && (
                            <div className="flex items-center gap-2">
                              <LocalTimeInput
                                syncKey={`${currentDayIndex}-${p.id}-hrs`}
                                initialValue={dayDraft[`${p.id}_hrs`] || ''}
                                placeholder="H"
                                onCommit={(val) => {
                                  setDayDraft(prev => ({ ...prev, [`${p.id}_hrs`]: val }));
                                  updateDayData(currentDayIndex, { [`${p.id}_hrs`]: val });
                                }}
                              />
                              <span className="text-slate-600 font-black">:</span>
                              <LocalTimeInput
                                syncKey={`${currentDayIndex}-${p.id}-mins`}
                                initialValue={dayDraft[`${p.id}_mins`] || ''}
                                placeholder="M"
                                onCommit={(val) => {
                                  setDayDraft(prev => ({ ...prev, [`${p.id}_mins`]: val }));
                                  updateDayData(currentDayIndex, { [`${p.id}_mins`]: val });
                                }}
                              />
                            </div>
                          )}
                        </div>

                        {p.id.startsWith('workout') && (
                          <textarea
                            className="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-sm text-slate-300 h-20 mb-3 font-bold outline-none"
                            placeholder="Workout details (optional)..."
                            value={dayDraft[`${p.id}_desc`] || ''}
                            onChange={(e) => setDayDraft(prev => ({ ...prev, [`${p.id}_desc`]: e.target.value }))}
                            onBlur={() => updateDayData(currentDayIndex, { [`${p.id}_desc`]: dayDraft[`${p.id}_desc`] })}
                          />
                        )}

                        {p.id === 'consumption' && (
                          <input
                            type="text"
                            className="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-sm text-slate-300 mb-3 font-bold outline-none"
                            placeholder={profile.consumptionType === 'reading' ? "Book title (or chapter)..." : "Podcast episode title..."}
                            value={dayDraft.consumptionTitle || ''}
                            onChange={(e) => setDayDraft(prev => ({ ...prev, consumptionTitle: e.target.value }))}
                            onBlur={() => updateDayData(currentDayIndex, { consumptionTitle: dayDraft.consumptionTitle })}
                          />
                        )}

                        {p.id === 'photo' && !dayDraft.photoData && !done && (
                          <button
                            onClick={() => fileInputRef.current?.click()}
                            className="w-full py-10 bg-slate-800/20 border-2 border-dashed border-slate-700 rounded-2xl flex flex-col items-center"
                          >
                            {isUploading
                              ? <div className="w-8 h-8 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mb-3"></div>
                              : <Icon name="upload" className="mb-2" />
                            }
                            <span className="text-xs font-black uppercase tracking-widest">Upload Image</span>
                            <input type="file" ref={fileInputRef} onChange={handlePhotoUpload} accept="image/*" className="hidden" />
                          </button>
                        )}

                        {p.id === 'photo' && dayDraft.photoData && (
                          <div className="relative aspect-video rounded-xl overflow-hidden mb-3">
                            <img src={dayDraft.photoData} className="w-full h-full object-cover" />
                            <button onClick={removePhoto} className="absolute top-2 right-2 p-2 bg-red-500 rounded-lg text-white">
                              <Icon name="trash-2" />
                            </button>
                          </div>
                        )}

                        <div className="flex gap-2">
                          {done ? (
                            <div className={`flex-1 py-3 bg-${themeColor}-500/20 border border-${themeColor}-500/50 rounded-xl text-xs text-${themeColor}-200 uppercase text-center font-black`}>
                              Completed
                            </div>
                          ) : (
                            <button
                              disabled={p.id.startsWith('workout') && !qualifiesOk}
                              onClick={() => {
                                const nextTasks = { ...dayDraft.tasks, [p.id]: true };
                                setDayDraft(prev => ({ ...prev, tasks: nextTasks }));
                                updateDayData(currentDayIndex, { tasks: nextTasks });
                              }}
                              className={`flex-1 py-3 border rounded-xl text-xs font-black uppercase ${
                                p.id.startsWith('workout') && !qualifiesOk
                                  ? 'bg-slate-900 border-slate-800 text-slate-600'
                                  : `bg-${themeColor}-600 border-${themeColor}-500 text-white hover:bg-${themeColor}-500 transition-all`
                              }`}
                            >
                              {p.id === 'photo' ? 'Skip & Complete' : 'Complete Task'}
                            </button>
                          )}

                          {/* ✅ UNDO restored */}
                          {done && (
                            <button
                              onClick={() => {
                                const nextTasks = { ...dayDraft.tasks, [p.id]: false };
                                setDayDraft(prev => ({ ...prev, tasks: nextTasks }));
                                updateDayData(currentDayIndex, { tasks: nextTasks });
                              }}
                              className="p-3 bg-slate-800 border border-slate-700 rounded-xl hover:text-rose-500 transition-colors"
                              title="Undo"
                            >
                              <Icon name="rotate-ccw" />
                            </button>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </>
            )}

            {activeTab === 'gallery' && (
              <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-2xl">
                <h3 className="text-lg font-black flex items-center gap-2 text-white mb-6">
                  <span className="text-pink-500"><Icon name="image" /></span> Evolution Gallery
                </h3>
                <div className="grid grid-cols-3 sm:grid-cols-4 gap-3">
                  {Array.from({ length: 75 }).map((_, i) => {
                    const info = daysData[`day-${i + 1}`];
                    const comp = checkDayComplete(info, profile);
                    return (
                      <button
                        key={i}
                        onClick={() => { setCurrentDayIndex(i); setActiveTab('today'); }}
                        className={`aspect-square relative rounded-xl border flex flex-col items-center justify-center ${
                          i === currentDayIndex ? 'border-orange-500 ring-2' : 'border-slate-800 bg-slate-800/30'
                        }`}
                      >
                        {info?.photoData
                          ? <img src={info.photoData} className="w-full h-full object-cover rounded-lg" />
                          : <div className="text-[8px] font-black uppercase">D {i + 1}</div>
                        }
                        {comp && <div className="absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full" />}
                      </button>
                    );
                  })}
                </div>
              </div>
            )}

            {activeTab === 'stats' && (
              <div className="space-y-6">
                <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl overflow-hidden relative text-center">
                  <h3 className="text-lg font-black mb-2 flex items-center justify-center gap-2 text-white">
                    <span className="text-orange-500"><Icon name="activity" /></span> Progress Trend
                  </h3>
                  <WeightChart data={weightTrendData} />
                  <div className="grid grid-cols-2 gap-4 mt-6 font-black text-[9px] uppercase">
                    <div className="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50">
                      Weight Change<br />
                      <span className="text-2xl text-green-400 font-bold">-{totalsData.weightLost} LBS</span>
                    </div>
                    <div className="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50">
                      Total Wins<br />
                      <span className="text-2xl text-cyan-400 font-bold">{totalsData.completedDays}</span>
                    </div>
                  </div>
                </div>

                <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl">
                  <h3 className="text-lg font-black mb-6 text-white flex items-center gap-2">
                    <span className="text-cyan-400"><Icon name="zap" /></span> Volume
                  </h3>
                  <div className="space-y-3">
                    <div className="flex justify-between text-xs font-black uppercase"><span>Hydration</span><span>{totalsData.totalWater} OZ</span></div>
                    <div className="flex justify-between text-xs font-black uppercase"><span>Training</span><span>{totalsData.hours}H {totalsData.mins}M</span></div>
                    <div className="flex justify-between text-xs font-black uppercase"><span>Education</span><span>{totalsData.totalEduValue} {profile.consumptionType === 'reading' ? 'Pages' : 'Mins'}</span></div>
                  </div>
                </div>

                <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl">
                  <h3 className="text-lg font-black mb-6 text-orange-500 flex items-center gap-2">
                    <Icon name="ruler" /> Body Snapshot
                  </h3>
                  <div className="grid grid-cols-2 gap-4 mb-6">
                    <input
                      type="number"
                      step="0.1"
                      className="bg-slate-950 p-3 rounded-xl border border-slate-800 font-bold outline-none"
                      placeholder="Start Weight"
                      value={profile.startWeight}
                      onChange={(e) => updateProfileOnTheFly({ startWeight: e.target.value })}
                    />
                    <input
                      type="number"
                      className="bg-slate-950 p-3 rounded-xl border border-slate-800 font-bold outline-none"
                      placeholder="Current Weight"
                      value={profile.currentWeight}
                      onChange={(e) => updateProfileOnTheFly({ currentWeight: e.target.value })}
                    />
                  </div>

                  <div className="grid grid-cols-3 gap-2 uppercase text-[9px] font-bold">
                    {['neck', 'chest', 'waist', 'arms', 'thighs', 'calves'].map(k => (
                      <div key={k}>
                        {k}
                        <input
                          type="number"
                          className="w-full bg-slate-950 p-2 mt-1 rounded border border-slate-800 font-bold outline-none"
                          value={profile.measurements?.[k] || ''}
                          onChange={(e) => updateProfileOnTheFly({ measurements: { ...profile.measurements, [k]: e.target.value } })}
                        />
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'tips' && (
              <div className="space-y-6">
                <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl">
                  <h3 className="text-xl font-black mb-4 text-orange-500 uppercase flex items-center gap-2">
                    <Icon name="lightbulb" /> Tips for Finishing Strong
                  </h3>

                  <div className="space-y-4 text-sm text-slate-300 leading-relaxed">
                    <div className="p-4 rounded-2xl bg-slate-800/30 border border-slate-800">
                      <div className="text-[10px] uppercase font-black text-slate-400 tracking-widest">Hydration strategy</div>
                      <div className="mt-2">
                        If your target is <span className="text-white font-black">128oz</span>, treat it like <span className="text-white font-black">4 x 32oz</span>:
                        morning, after workout #1, after workout #2, and with dinner. Don’t “save it for later.”
                      </div>
                    </div>

                    <div className="p-4 rounded-2xl bg-slate-800/30 border border-slate-800">
                      <div className="text-[10px] uppercase font-black text-slate-400 tracking-widest">Two workouts</div>
                      <div className="mt-2">
                        Plan them early. Outdoors first is usually easiest (weather + daylight). If you wait until night, one delay can wipe the day.
                      </div>
                    </div>

                    <div className="p-4 rounded-2xl bg-slate-800/30 border border-slate-800">
                      <div className="text-[10px] uppercase font-black text-slate-400 tracking-widest">Make it “default”</div>
                      <div className="mt-2">
                        Put the workout clothes where you trip over them, keep the book in your bag/car, and set a recurring daily reminder for photo + reading.
                      </div>
                    </div>

                    <div className="p-4 rounded-2xl bg-slate-800/30 border border-slate-800">
                      <div className="text-[10px] uppercase font-black text-slate-400 tracking-widest">Reading actually happens</div>
                      <div className="mt-2">
                        Don’t do it in bed. Knock out the pages with coffee, lunch break, or right after workout #1.
                      </div>
                    </div>

                    <div className="p-4 rounded-2xl bg-slate-800/30 border border-slate-800">
                      <div className="text-[10px] uppercase font-black text-slate-400 tracking-widest">Diet friction</div>
                      <div className="mt-2">
                        The easiest “fail point” is food. Pre-decide your non-negotiables and keep 2–3 backup meals stocked that match your plan.
                      </div>
                    </div>

                    <div className="p-4 rounded-2xl bg-slate-800/30 border border-slate-800">
                      <div className="text-[10px] uppercase font-black text-slate-400 tracking-widest">Bad weather plan</div>
                      <div className="mt-2">
                        If it’s windy, cold, or raining: shorten the decision, not the workout. Pick a “rain workout” you’ll do without debating (walk, ruck, easy jog).
                      </div>
                    </div>

                    <div className="p-4 rounded-2xl bg-slate-800/30 border border-slate-800">
                      <div className="text-[10px] uppercase font-black text-slate-400 tracking-widest">The rule test</div>
                      <div className="mt-2">
                        If you have to ask if it counts… pause. Decide before you act, and keep your definition consistent across all 75 days.
                      </div>
                    </div>

                    <a
                      href="https://www.facebook.com/groups/75hard"
                      target="_blank"
                      rel="noreferrer"
                      className="flex items-center justify-between p-4 bg-indigo-600 rounded-xl text-white font-black uppercase text-xs hover:bg-indigo-500 transition-colors shadow-lg"
                    >
                      Join the Official 75 Hard Facebook Group <Icon name="external-link" />
                    </a>
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'setup' && (
              <>
                <LockToast />
                {renderSetupUI(true)}
              </>
            )}
          </main>

          {appPhase === 'dashboard' && (
            <footer className="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-xl border-t border-slate-800 px-6 py-4 z-50 lg:hidden">
              <div className="max-w-lg mx-auto text-center space-y-1">
                <p className="text-[10px] font-black uppercase text-orange-500 tracking-widest">Remember Why You Started</p>
                <p className="italic text-xs text-slate-300 line-clamp-2 px-4">"{profile.intentions || "Commit to your journey."}"</p>
              </div>
            </footer>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <script>
  // PWA service worker registration (safe to include even if sw.js is missing)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js").catch(() => {});
    });
  }
</script>

</body>
</html>


